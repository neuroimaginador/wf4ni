---
title: "Using `wf4ni` to Compute Tractography"
author: "Domingo López-Rodríguez"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
 %\VignetteIndexEntry{Using `wf4ni` to Compute Tractography}
 %\VignetteEngine{knitr::rmarkdown}
 %\VignetteEncoding{UTF-8}
---
  
```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = nzchar(Sys.getenv("MY_EVAL_VARIABLE"))
)
```

# Objective

# Requirements

## Packages

```{r messages = FALSE, warning=FALSE}
library(wf4ni)
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
library(tidyverse)
library(neurobase)
library(oro.nifti)
library(fslr)
library(dti)
library(readr)
```


## Other Resources

# DTI Processing

```{r dti_flow}
dti_flow <- NIflow$new(name = "dti",
                       work_dir = "~/flow/dti",
                       inputs = c("dwi", "grads", "bvals"))
```


## Eddy Current Correction

```{r eddy}
correct_dwi <- function(image) {

  my_dwi_file <- tempimg(as.nifti(image))

  dwi_corrected <- eddy_correct(infile = my_dwi_file)

  return(dwi_corrected)

}
```

```{r eddy_flow}
dti_flow %>%
  add(what = correct_dwi,
      inputs = "dwi",
      output = "dwi_corrected")
```


## Tensor Computation

```{r tensor}
read_data <- function(image, grads, bvals) {

  my_dwi_corrected_file <- tempimg(image)

  dwi_data <- readDWIdata(gradient = grads,
                          dirlist = my_dwi_corrected_file,
                          bvalue = bvals,
                          format = "NIFTI")

  return(dwi_data)

}

compute_tensors <- function(dwi_data) {

  tensors <- dtiTensor(dwi_data)

  return(tensors)

}
```

```{r tensor_flow}
dti_flow %>%
  add(what = read_data,
      inputs = c("dwi_corrected", "grads", "bvals"),
      output = "dwiData") %>%
  add(what = compute_tensors,
      inputs = "dwiData",
      output = "tensors")
```

## Mask Computation

```{r mask}
get_S0 <- function(tensors) {

  return(as.nifti(tensors@th0))

}

compute_mask <- function(S0) {

  S0_file <- tempimg(S0)

  brain_mask <- fslbet(infile = S0_file)

  return(brain_mask > 0)

}
```

```{r mask_flow}
dti_flow %>%
  add(what = get_S0,
      inputs = "tensors",
      output = "S0") %>%
  add(what = compute_mask,
      inputs = "S0",
      output = "mask")
```


## Fiber Tracking

```{r fibertracking}
fibertracking <- function(tensors, mask) {

  fibers <- tracking(tensors,
                     mask = mask)

  return(fibers)

}
```

```{r fibertracking_flow}
dti_flow %>%
  add(what = fibertracking,
      inputs = c("tensors", "mask"),
      output = "fibers")
```

## FA Map

```{r fa}
compute_FA <- function(tensors, mask) {

  indices <- dtiIndices(tensors)

  FA_map <- indices@fa * mask

  return(FA_map)

}
```

```{r fa_flow}
dti_flow %>%
  add(what = compute_FA,
      inputs = c("tensors", "mask"),
      output = "FA_map")
```

# Final Flow

```{r flow_plot, echo=TRUE, fig.show='asis', fig.width = 7, fig.asp = 1}
dti_flow$plot()
```

# Example

```{r echo = FALSE}
lag <- stats::lag
```

```{r example, eval = FALSE}

dwi_file <- "./resources/dti/dti_example.nii.gz"
bvals_file <- "./resources/dti/dti_bvals.csv"
grads_file <- "./resources/dti/dti_gradients.csv"

dwi <- readnii(dwi_file)
bvals <- read_csv(bvals_file,
                  col_names = FALSE,
                  col_types = cols()) %>% unlist()
gradients <- read_csv(grads_file,
                      col_names = FALSE,
                      col_types = cols()) %>%
  as.matrix()

res <- dti_flow$execute(inputs = list(dwi = dwi,
                                      grads = gradients,
                                      bvals = bvals),
                        desired_outputs = c("S0", 
                                            "fibers", 
                                            "FA_map"))

```

```{r eval = FALSE} 
neurobase::ortho2(res$S0)
```

```{r, out.width = 700, fig.asp = 1, eval = TRUE, echo = FALSE}
knitr::include_graphics(path = "./img/dti_S0.png")
```

```{r eval = FALSE} 
neurobase::ortho2(res$FA_map)
```

```{r, out.width = 700, fig.asp = 1, eval = TRUE, echo = FALSE}
knitr::include_graphics(path = "./img/dti_FA_map.png")
```

```{r eval = FALSE}
show3d(res$fibers)
```

```{r, out.width = 700, fig.asp = 1, eval = TRUE, echo = FALSE}
knitr::include_graphics(path = "./img/dti_fibers1.png")
knitr::include_graphics(path = "./img/dti_fibers2.png")
knitr::include_graphics(path = "./img/dti_fibers3.png")
knitr::include_graphics(path = "./img/dti_fibers4.png")
```


## Full Flow Log

```{r print_log, eval = FALSE}
dti_flow$print_log()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
lines <- readLines(con = "./resources/dti/log.txt")

cat(lines, sep = "\n")
```

# Availability