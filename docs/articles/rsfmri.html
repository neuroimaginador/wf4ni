<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using <code>wf4ni</code> for Resting State fMRI processing • wf4ni</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using &lt;code&gt;wf4ni&lt;/code&gt; for Resting State fMRI processing">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">wf4ni</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/wf4ni.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/rsfmri.html">Using `wf4ni` for Resting State fMRI processing</a>
    </li>
    <li>
      <a href="../articles/tractography.html">Using `wf4ni` to Compute Tractography</a>
    </li>
    <li>
      <a href="../articles/volumetry.html">Using `wf4ni` to Build a Volumetry Flow</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/neuroimaginador/wf4ni">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Using <code>wf4ni</code> for Resting State fMRI processing</h1>
                        <h4 class="author">Domingo López-Rodríguez</h4>
            
            <h4 class="date">2019-05-07</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/neuroimaginador/wf4ni/blob/master/vignettes/rsfmri.Rmd"><code>vignettes/rsfmri.Rmd</code></a></small>
      <div class="hidden name"><code>rsfmri.Rmd</code></div>

    </div>

    
    
<div id="objective" class="section level1">
<h1 class="hasAnchor">
<a href="#objective" class="anchor"></a>Objective</h1>
<p>In this vignette, we’re going to develop a pipeline (workflow) to build the functional connectome from a resting state fMRI volume, associated to an atlas, using the <code>wf4ni</code> package.</p>
<p>As a model, we have used the steps mentioned in the <a href="https://wiki.biac.duke.edu/biac:analysis:resting_pipeline">Python/FSL Resting State Pipeline</a> from the <a href="https://wiki.biac.duke.edu">Brain Imaging and Analysis Center</a>:</p>
<ul>
<li>Slice time correction</li>
<li>Motion correction, then regress out motion parameter</li>
<li>Skull stripping</li>
<li>Data normalization</li>
<li>Regress out WM/CSF signal</li>
<li>Bandpass filter</li>
<li>Do parcellation and produce correlation matrix from label file</li>
</ul>
<p>To demonstrate the flexibility of <code>wf4ni</code>, we’ll use different <code>R</code> packages to perform several of the above steps.</p>
<p>It must be noted that the philosophy of <code>wf4ni</code> is to separate the pipeline logic from its implementation. So, the same workflow could be used just changing, if needed, the implementation of any (or all) of the steps above.</p>
<p>The organization of this vignette is as follows. First, we’ll describe the dependencies or packages needed to run the workflow. Later, we’ll describe the workflow, step by step, without presenting the actual implementation of the functions used. Then, we’ll use some sample data to run an experiment with the workflow, presenting its results. We’ll end the vignette with an annex in which we’ll present the actual implementation of the functions.</p>
</div>
<div id="requirements" class="section level1">
<h1 class="hasAnchor">
<a href="#requirements" class="anchor"></a>Requirements</h1>
<p>We consider two types of requirements: packages needed to perform the key steps in the workflow and data which may be necessary at any step of the computation.</p>
<div id="packages" class="section level2">
<h2 class="hasAnchor">
<a href="#packages" class="anchor"></a>Packages</h2>
<p>Obviously, to build the workflow, we need the <code>wf4ni</code> package:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(wf4ni)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="co">#&gt; Attaching package: 'wf4ni'</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="co">#&gt; The following object is masked from 'package:base':</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="co">#&gt;     merge</span></a></code></pre></div>
<p>The following packages are needed in some points of the pipeline:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="kw">library</span>(neurobase)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="kw">library</span>(fslr)</a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="kw">library</span>(readr)</a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="kw">library</span>(oro.nifti)</a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="kw">library</span>(ANTsR)</a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="kw">library</span>(signal)</a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="kw">library</span>(scales)</a>
<a class="sourceLine" id="cb2-9" data-line-number="9"><span class="kw">library</span>(RColorBrewer)</a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="kw">library</span>(tidyr)</a>
<a class="sourceLine" id="cb2-11" data-line-number="11"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb2-12" data-line-number="12"><span class="kw">library</span>(ggplot2)</a></code></pre></div>
<p>The <code>tidyverse</code> simplifies some of the functions and makes code more legible. Packages <code>fslr</code>, <code>ANTsR</code>, and <code>signal</code> are used in different parts of the code. <code>neurobase</code>, <code>oro.nifti</code> and <code>readr</code> are used in input/output tasks and to show orthographic plots of nifti volumes. Packages <code>RColorBrewer</code>, <code>tidyr</code>, <code>dplyr</code> and <code>ggplot2</code> are used to visualize the results.</p>
</div>
<div id="other-resources" class="section level2">
<h2 class="hasAnchor">
<a href="#other-resources" class="anchor"></a>Other Resources</h2>
<p>The additional resources, such as the atlas used in this vignette to compute the functional connectome (AAL v4), or the WM/CSF probability map templates, are from the <a href="https://wiki.biac.duke.edu/biac:analysis:resting_pipeline">Python/FSL Resting State Pipeline</a>, mentioned above.</p>
</div>
</div>
<div id="fmri-processing" class="section level1">
<h1 class="hasAnchor">
<a href="#fmri-processing" class="anchor"></a>fMRI Processing</h1>
<p>The diffusion workflow will be a <code>NIflow</code> object. To create such object, one needs to provide a <em>name</em>, a <em>work_dir</em> where to store temporary results, and the name of the <em>inputs</em> needed to execute the workflow. In this case, our pipeline will need:</p>
<ul>
<li>A T1 image in nifti format.</li>
<li>A rsfMRI image (BOLD) also in nifti format.</li>
<li>The TR of the acquisition.</li>
<li>The atlas with the appropriate labels to compute the connectome.</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">fmri_flow &lt;-<span class="st"> </span>NIflow<span class="op">$</span><span class="kw">new</span>(<span class="dt">name =</span> <span class="st">"fmri"</span>,</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">                        <span class="dt">work_dir =</span> <span class="st">"~/flow/fmri"</span>,</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">                        <span class="dt">inputs =</span> <span class="kw">c</span>(<span class="st">"T1"</span>, <span class="st">"BOLD"</span>, <span class="st">"TR"</span>, <span class="st">"atlas"</span>))</a></code></pre></div>
<p>There will be processes exclusively acting on the fMRI image, whereas others will act on the T1 image, for different purposes. Having a T1 image will help normalize the functional image into MNI space.</p>
<div id="slice-time-correction" class="section level2">
<h2 class="hasAnchor">
<a href="#slice-time-correction" class="anchor"></a>Slice Time Correction</h2>
<p>The first action to take is to correct the functional image for slice timing, using <code>fslr</code> package:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># slice time correction</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">correct_slice_time &lt;-<span class="st"> </span><span class="cf">function</span>(bold) {</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">  <span class="co">#...</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4">}</a></code></pre></div>
<p>Adding this step to the flow is straightforward:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">fmri_flow <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> correct_slice_time,</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">      <span class="dt">inputs =</span> <span class="st">"BOLD"</span>,</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">      <span class="dt">output =</span> <span class="st">"bold_slice_time"</span>)</a></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">fmri_flow<span class="op">$</span><span class="kw"><a href="../reference/plot.html">plot</a></span>()</a></code></pre></div>
<p><img src="rsfmri_files/figure-html/unnamed-chunk-3-1.png" width="480"></p>
</div>
<div id="motion-correction" class="section level2">
<h2 class="hasAnchor">
<a href="#motion-correction" class="anchor"></a>Motion Correction</h2>
<p>The next step is correcting the motion between different acquisitions (using <code>fslr</code>), and regress out the effect of the motion in the fMRI signal (using functions from base <code>R</code>):</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="co"># run motion correction</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2">correct_motion &lt;-<span class="st"> </span><span class="cf">function</span>(bold) {</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">  <span class="co">#...</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb7-5" data-line-number="5"></a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="co"># regressing out motion correction parameters</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7">regress_out_motion &lt;-<span class="st"> </span><span class="cf">function</span>(L) {</a>
<a class="sourceLine" id="cb7-8" data-line-number="8">  <span class="co">#...</span></a>
<a class="sourceLine" id="cb7-9" data-line-number="9">}</a></code></pre></div>
<p>Adding these two steps can be made as follows:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">fmri_flow <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> correct_motion,</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">      <span class="dt">inputs =</span> <span class="st">"bold_slice_time"</span>,</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">      <span class="dt">output =</span> <span class="st">"motion_estimation"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> regress_out_motion,</a>
<a class="sourceLine" id="cb8-6" data-line-number="6">      <span class="dt">inputs =</span> <span class="st">"motion_estimation"</span>,</a>
<a class="sourceLine" id="cb8-7" data-line-number="7">      <span class="dt">output =</span> <span class="st">"bold_motion_regressed"</span>)</a></code></pre></div>
<p>At this point, the partial flow is:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">fmri_flow<span class="op">$</span><span class="kw"><a href="../reference/plot.html">plot</a></span>()</a></code></pre></div>
<p><img src="rsfmri_files/figure-html/unnamed-chunk-4-1.png" width="480"></p>
</div>
<div id="skull-strip-functional-image" class="section level2">
<h2 class="hasAnchor">
<a href="#skull-strip-functional-image" class="anchor"></a>Skull Strip Functional Image</h2>
<p>In order to remove the exterior of the brain, we will follow the next actions:</p>
<ul>
<li>Compute the average functional image.</li>
<li>Extract a brain mask from this averaged image.</li>
<li>Use that result to mask the whole run.</li>
</ul>
<p>Some of these functions need the <code>fslr</code> package.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co">#first create mean_func</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2">compute_mean_func &lt;-<span class="st"> </span><span class="cf">function</span>(image) {</a>
<a class="sourceLine" id="cb10-3" data-line-number="3">  <span class="co">#...</span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb10-5" data-line-number="5"></a>
<a class="sourceLine" id="cb10-6" data-line-number="6"><span class="co">#now skull strip the mean</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7">skull_strip &lt;-<span class="st"> </span><span class="cf">function</span>(image) {</a>
<a class="sourceLine" id="cb10-8" data-line-number="8">  <span class="co">#...</span></a>
<a class="sourceLine" id="cb10-9" data-line-number="9">}</a>
<a class="sourceLine" id="cb10-10" data-line-number="10"></a>
<a class="sourceLine" id="cb10-11" data-line-number="11"><span class="co">#now mask full run by results</span></a>
<a class="sourceLine" id="cb10-12" data-line-number="12">mask_run &lt;-<span class="st"> </span><span class="cf">function</span>(image, mask) {</a>
<a class="sourceLine" id="cb10-13" data-line-number="13">  <span class="co">#...</span></a>
<a class="sourceLine" id="cb10-14" data-line-number="14">}</a></code></pre></div>
<p>We concatenate this functions as follows:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">fmri_flow <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> compute_mean_func,</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">      <span class="dt">inputs =</span> <span class="st">"bold_motion_regressed"</span>,</a>
<a class="sourceLine" id="cb11-4" data-line-number="4">      <span class="dt">output =</span> <span class="st">"mean_func"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> skull_strip,</a>
<a class="sourceLine" id="cb11-6" data-line-number="6">      <span class="dt">inputs =</span> <span class="st">"mean_func"</span>,</a>
<a class="sourceLine" id="cb11-7" data-line-number="7">      <span class="dt">output =</span> <span class="st">"mean_func_brain"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-8" data-line-number="8"><span class="st">  </span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> mask_run,</a>
<a class="sourceLine" id="cb11-9" data-line-number="9">      <span class="dt">inputs =</span> <span class="kw">c</span>(<span class="st">"bold_motion_regressed"</span>, <span class="st">"mean_func_brain"</span>),</a>
<a class="sourceLine" id="cb11-10" data-line-number="10">      <span class="dt">output =</span> <span class="st">"bold_masked"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-11" data-line-number="11"><span class="st">  </span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> skull_strip,</a>
<a class="sourceLine" id="cb11-12" data-line-number="12">      <span class="dt">inputs =</span> <span class="st">"T1"</span>,</a>
<a class="sourceLine" id="cb11-13" data-line-number="13">      <span class="dt">output =</span> <span class="st">"T1_brain"</span>)</a></code></pre></div>
<p>Note that we also skull-strip the T1 image. This way, later, we’ll be able to reorient the anatomical image into MNI space.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">fmri_flow<span class="op">$</span><span class="kw"><a href="../reference/plot.html">plot</a></span>()</a></code></pre></div>
<p><img src="rsfmri_files/figure-html/unnamed-chunk-5-1.png" width="480"></p>
</div>
<div id="normalize-data" class="section level2">
<h2 class="hasAnchor">
<a href="#normalize-data" class="anchor"></a>Normalize data</h2>
<p>In this step, we reorient both the anaotmical and the functional images into MNI space. We’ll use <code>fslr</code> functions to this end.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="co"># normalize the data</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2">normalize_data &lt;-<span class="st"> </span><span class="cf">function</span>(t1_ss, bold_ss) {</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">  <span class="co">#...</span></a>
<a class="sourceLine" id="cb13-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb13-5" data-line-number="5"></a>
<a class="sourceLine" id="cb13-6" data-line-number="6">get_t12std &lt;-<span class="st"> </span><span class="cf">function</span>(L) L<span class="op">$</span>t12std_img</a>
<a class="sourceLine" id="cb13-7" data-line-number="7">get_func2std &lt;-<span class="st"> </span><span class="cf">function</span>(L) L<span class="op">$</span>func2std_img</a></code></pre></div>
<p>Taking into account the corresponding inputs and outputs, the code to add this functions to the flow is:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">fmri_flow <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> normalize_data,</a>
<a class="sourceLine" id="cb14-3" data-line-number="3">      <span class="dt">inputs =</span> <span class="kw">c</span>(<span class="st">"T1_brain"</span>, <span class="st">"bold_masked"</span>),</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">      <span class="dt">output =</span> <span class="st">"all_normalized"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> get_t12std,</a>
<a class="sourceLine" id="cb14-6" data-line-number="6">      <span class="dt">inputs =</span> <span class="st">"all_normalized"</span>,</a>
<a class="sourceLine" id="cb14-7" data-line-number="7">      <span class="dt">output =</span> <span class="st">"t12std"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-8" data-line-number="8"><span class="st">  </span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> get_func2std,</a>
<a class="sourceLine" id="cb14-9" data-line-number="9">      <span class="dt">inputs =</span> <span class="st">"all_normalized"</span>,</a>
<a class="sourceLine" id="cb14-10" data-line-number="10">      <span class="dt">output =</span> <span class="st">"func2std"</span>)</a></code></pre></div>
<p>The flow up-to-now is as follows:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">fmri_flow<span class="op">$</span><span class="kw"><a href="../reference/plot.html">plot</a></span>()</a></code></pre></div>
<p><img src="rsfmri_files/figure-html/unnamed-chunk-6-1.png" width="480"></p>
</div>
<div id="regress-out-wm-and-csf-signals" class="section level2">
<h2 class="hasAnchor">
<a href="#regress-out-wm-and-csf-signals" class="anchor"></a>Regress out WM and CSF Signals</h2>
<p>To regress out CSF and WM signal, we use base <code>R</code> functions. The CSF and WM maps are obtained from the external resources mentioned above.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="co"># regress out WM/CSF</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2">regress_out_wm_csf &lt;-<span class="st"> </span><span class="cf">function</span>(func2std_img) {</a>
<a class="sourceLine" id="cb16-3" data-line-number="3">  <span class="co">#...</span></a>
<a class="sourceLine" id="cb16-4" data-line-number="4">}</a></code></pre></div>
<p>We add this step to the flow:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">fmri_flow <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> regress_out_wm_csf,</a>
<a class="sourceLine" id="cb17-3" data-line-number="3">      <span class="dt">inputs =</span> <span class="st">"func2std"</span>,</a>
<a class="sourceLine" id="cb17-4" data-line-number="4">      <span class="dt">output =</span> <span class="st">"func2std_out_wm_csf"</span>)</a></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">fmri_flow<span class="op">$</span><span class="kw"><a href="../reference/plot.html">plot</a></span>()</a></code></pre></div>
<p><img src="rsfmri_files/figure-html/unnamed-chunk-7-1.png" width="480"></p>
</div>
<div id="bandpass-filter" class="section level2">
<h2 class="hasAnchor">
<a href="#bandpass-filter" class="anchor"></a>Bandpass Filter</h2>
<p>We’ll use functions from the <code>ANTsR</code> package to filter the functional image. We’ll also need the TR of the acquisition as input for this step.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="co"># bandpass filter</span></a>
<a class="sourceLine" id="cb19-2" data-line-number="2">filter_func &lt;-<span class="st"> </span><span class="cf">function</span>(func, tr) {</a>
<a class="sourceLine" id="cb19-3" data-line-number="3">  <span class="co">#...</span></a>
<a class="sourceLine" id="cb19-4" data-line-number="4">}</a></code></pre></div>
<p>This way we add the function to the flow_</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">fmri_flow <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> filter_func,</a>
<a class="sourceLine" id="cb20-3" data-line-number="3">      <span class="dt">inputs =</span> <span class="kw">c</span>(<span class="st">"func2std_out_wm_csf"</span>, <span class="st">"TR"</span>),</a>
<a class="sourceLine" id="cb20-4" data-line-number="4">      <span class="dt">output =</span> <span class="st">"func_filtered"</span>)</a></code></pre></div>
<p>The partial flow is now:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">fmri_flow<span class="op">$</span><span class="kw"><a href="../reference/plot.html">plot</a></span>()</a></code></pre></div>
<p><img src="rsfmri_files/figure-html/unnamed-chunk-8-1.png" width="480"></p>
</div>
<div id="extract-time-series-and-compute-correlation" class="section level2">
<h2 class="hasAnchor">
<a href="#extract-time-series-and-compute-correlation" class="anchor"></a>Extract Time-Series and Compute Correlation</h2>
<p>First, we extract a functional time series for each of the regions of interest in the labelled atlas, as the mean of the signal, at each timepoint, over all voxels of the corresponding region.</p>
<p>Later, we compute the correlation of those time series to extract the functional connectome associated to the labelling.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1"><span class="co"># do the parcellation</span></a>
<a class="sourceLine" id="cb22-2" data-line-number="2">extract_time_series &lt;-<span class="st"> </span><span class="cf">function</span>(bold, corr_label) {</a>
<a class="sourceLine" id="cb22-3" data-line-number="3">  <span class="co">#...</span></a>
<a class="sourceLine" id="cb22-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb22-5" data-line-number="5"></a>
<a class="sourceLine" id="cb22-6" data-line-number="6"><span class="co"># do the correlation</span></a>
<a class="sourceLine" id="cb22-7" data-line-number="7">compute_correlation &lt;-<span class="st"> </span><span class="cf">function</span>(time_series) {</a>
<a class="sourceLine" id="cb22-8" data-line-number="8">  <span class="co">#...</span></a>
<a class="sourceLine" id="cb22-9" data-line-number="9">}</a></code></pre></div>
<p>We add this last steps to the flow as follows:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1">fmri_flow <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb23-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> extract_time_series,</a>
<a class="sourceLine" id="cb23-3" data-line-number="3">      <span class="dt">inputs =</span> <span class="kw">c</span>(<span class="st">"func_filtered"</span>, <span class="st">"atlas"</span>),</a>
<a class="sourceLine" id="cb23-4" data-line-number="4">      <span class="dt">output =</span> <span class="st">"ts"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb23-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> compute_correlation,</a>
<a class="sourceLine" id="cb23-6" data-line-number="6">      <span class="dt">inputs =</span> <span class="st">"ts"</span>,</a>
<a class="sourceLine" id="cb23-7" data-line-number="7">      <span class="dt">output =</span> <span class="st">"cormat"</span>)</a></code></pre></div>
</div>
</div>
<div id="final-flow" class="section level1">
<h1 class="hasAnchor">
<a href="#final-flow" class="anchor"></a>Final Flow</h1>
<p>With these final additions, the complete pipeline is as follows:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1">fmri_flow<span class="op">$</span><span class="kw"><a href="../reference/plot.html">plot</a></span>()</a></code></pre></div>
<p><img src="rsfmri_files/figure-html/flow_plot-1.png" width="672"></p>
<p>We can also obtain a brief summary of the flow by typing:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="kw">summary</span>(fmri_flow)</a>
<a class="sourceLine" id="cb25-2" data-line-number="2"><span class="co">#&gt; NIflow object with:</span></a>
<a class="sourceLine" id="cb25-3" data-line-number="3"><span class="co">#&gt;   name: fmri </span></a>
<a class="sourceLine" id="cb25-4" data-line-number="4"><span class="co">#&gt;   inputs: T1, BOLD, TR, atlas </span></a>
<a class="sourceLine" id="cb25-5" data-line-number="5"><span class="co">#&gt;   outputs: bold_slice_time, motion_estimation, bold_motion_regressed, mean_func, mean_func_brain, bold_masked, T1_brain, all_normalized, t12std, func2std, func2std_out_wm_csf, func_filtered, ts, cormat </span></a>
<a class="sourceLine" id="cb25-6" data-line-number="6"><span class="co">#&gt; Currently using 787.27 kB of memory.</span></a>
<a class="sourceLine" id="cb25-7" data-line-number="7"><span class="co">#&gt; Summary of processes:</span></a>
<a class="sourceLine" id="cb25-8" data-line-number="8"><span class="co">#&gt;   bold_slice_time needs BOLD as inputs.</span></a>
<a class="sourceLine" id="cb25-9" data-line-number="9"><span class="co">#&gt;   motion_estimation needs bold_slice_time as inputs.</span></a>
<a class="sourceLine" id="cb25-10" data-line-number="10"><span class="co">#&gt;   bold_motion_regressed needs motion_estimation as inputs.</span></a>
<a class="sourceLine" id="cb25-11" data-line-number="11"><span class="co">#&gt;   mean_func needs bold_motion_regressed as inputs.</span></a>
<a class="sourceLine" id="cb25-12" data-line-number="12"><span class="co">#&gt;   mean_func_brain needs mean_func as inputs.</span></a>
<a class="sourceLine" id="cb25-13" data-line-number="13"><span class="co">#&gt;   bold_masked needs bold_motion_regressed, mean_func_brain as inputs.</span></a>
<a class="sourceLine" id="cb25-14" data-line-number="14"><span class="co">#&gt;   T1_brain needs T1 as inputs.</span></a>
<a class="sourceLine" id="cb25-15" data-line-number="15"><span class="co">#&gt;   all_normalized needs T1_brain, bold_masked as inputs.</span></a>
<a class="sourceLine" id="cb25-16" data-line-number="16"><span class="co">#&gt;   t12std needs all_normalized as inputs.</span></a>
<a class="sourceLine" id="cb25-17" data-line-number="17"><span class="co">#&gt;   func2std needs all_normalized as inputs.</span></a>
<a class="sourceLine" id="cb25-18" data-line-number="18"><span class="co">#&gt;   func2std_out_wm_csf needs func2std as inputs.</span></a>
<a class="sourceLine" id="cb25-19" data-line-number="19"><span class="co">#&gt;   func_filtered needs func2std_out_wm_csf, TR as inputs.</span></a>
<a class="sourceLine" id="cb25-20" data-line-number="20"><span class="co">#&gt;   ts needs func_filtered, atlas as inputs.</span></a>
<a class="sourceLine" id="cb25-21" data-line-number="21"><span class="co">#&gt;   cormat needs ts as inputs.</span></a></code></pre></div>
</div>
<div id="example" class="section level1">
<h1 class="hasAnchor">
<a href="#example" class="anchor"></a>Example</h1>
<p>To illustrate how this workflow can be used, let us suppose that we have all the functions mentioned before already implemented (an example implementation is given in the Annex), and build the workflow as in the previous steps. We’ll apply this flow to compute the connectome given a rsfMRI image.</p>
<div id="code" class="section level2">
<h2 class="hasAnchor">
<a href="#code" class="anchor"></a>Code</h2>
<p>We’ll use sample data for the rsfMRI image from <a href="https://openfmri.org/dataset/">openfMRI repositories</a>.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1">T1_file &lt;-<span class="st"> "./resources/rsfMRI/anat.nii.gz"</span></a>
<a class="sourceLine" id="cb26-2" data-line-number="2">BOLD_file &lt;-<span class="st"> "./resources/rsfMRI/func.nii.gz"</span></a>
<a class="sourceLine" id="cb26-3" data-line-number="3">atlas_file &lt;-<span class="st"> </span><span class="kw">file.path</span>(<span class="st">"./resources/rsfMRI/"</span>,</a>
<a class="sourceLine" id="cb26-4" data-line-number="4">                        <span class="st">'data'</span>, <span class="st">'aal_MNI_V4.nii'</span>)</a>
<a class="sourceLine" id="cb26-5" data-line-number="5">TR &lt;-<span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb26-6" data-line-number="6"></a>
<a class="sourceLine" id="cb26-7" data-line-number="7">res &lt;-<span class="st"> </span>fmri_flow<span class="op">$</span><span class="kw"><a href="../reference/execute.html">execute</a></span>(<span class="dt">inputs =</span> <span class="kw">list</span>(<span class="dt">T1 =</span> T1_file,</a>
<a class="sourceLine" id="cb26-8" data-line-number="8">                                       <span class="dt">BOLD =</span> BOLD_file,</a>
<a class="sourceLine" id="cb26-9" data-line-number="9">                                       <span class="dt">TR =</span> TR,</a>
<a class="sourceLine" id="cb26-10" data-line-number="10">                                       <span class="dt">atlas =</span> atlas_file),</a>
<a class="sourceLine" id="cb26-11" data-line-number="11">                         <span class="dt">desired_outputs =</span> <span class="kw">c</span>(<span class="st">"mean_func"</span>,</a>
<a class="sourceLine" id="cb26-12" data-line-number="12">                                             <span class="st">"ts"</span>,</a>
<a class="sourceLine" id="cb26-13" data-line-number="13">                                             <span class="st">"cormat"</span>))</a></code></pre></div>
</div>
<div id="images" class="section level2">
<h2 class="hasAnchor">
<a href="#images" class="anchor"></a>Images</h2>
<p>These are auxiliary functions to plot a connectivity matrix and a time series.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1">plot_matrix &lt;-<span class="st"> </span><span class="cf">function</span>(M) {</a>
<a class="sourceLine" id="cb27-2" data-line-number="2"></a>
<a class="sourceLine" id="cb27-3" data-line-number="3">  color_function &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/scales/topics/colour_ramp">colour_ramp</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/RColorBrewer/topics/ColorBrewer">brewer.pal</a></span>(<span class="dv">11</span>, <span class="st">"RdBu"</span>))</a>
<a class="sourceLine" id="cb27-4" data-line-number="4">  <span class="kw">heatmap</span>(<span class="kw">t</span>(M), <span class="dt">Rowv =</span> <span class="ot">NA</span>, <span class="dt">Colv =</span> <span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb27-5" data-line-number="5">          <span class="dt">col =</span> <span class="kw">color_function</span>(<span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.01</span>)),</a>
<a class="sourceLine" id="cb27-6" data-line-number="6">          <span class="dt">scale =</span> <span class="st">"none"</span>)</a>
<a class="sourceLine" id="cb27-7" data-line-number="7"></a>
<a class="sourceLine" id="cb27-8" data-line-number="8">}</a>
<a class="sourceLine" id="cb27-9" data-line-number="9"></a>
<a class="sourceLine" id="cb27-10" data-line-number="10">plot_time_series &lt;-<span class="st"> </span><span class="cf">function</span>(ts) {</a>
<a class="sourceLine" id="cb27-11" data-line-number="11"></a>
<a class="sourceLine" id="cb27-12" data-line-number="12">  <span class="co"># Runs on rows, ROIs in columns</span></a>
<a class="sourceLine" id="cb27-13" data-line-number="13">  ts &lt;-<span class="st"> </span><span class="kw">t</span>(ts) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.data.frame</span>()</a>
<a class="sourceLine" id="cb27-14" data-line-number="14"></a>
<a class="sourceLine" id="cb27-15" data-line-number="15">  n_runs &lt;-<span class="st"> </span><span class="kw">nrow</span>(ts)</a>
<a class="sourceLine" id="cb27-16" data-line-number="16">  ts<span class="op">$</span>run &lt;-<span class="st"> </span><span class="kw">seq</span>(n_runs)</a>
<a class="sourceLine" id="cb27-17" data-line-number="17"></a>
<a class="sourceLine" id="cb27-18" data-line-number="18">  df &lt;-<span class="st"> </span>ts <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb27-19" data-line-number="19"><span class="st">    </span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span>(<span class="dt">key =</span> <span class="st">"variable"</span>, <span class="dt">value =</span> <span class="st">"value"</span>, <span class="op">-</span>run)</a>
<a class="sourceLine" id="cb27-20" data-line-number="20"></a>
<a class="sourceLine" id="cb27-21" data-line-number="21">  <span class="cf">if</span> (<span class="kw">ncol</span>(ts) <span class="op">&gt;</span><span class="st"> </span><span class="dv">3</span>) {</a>
<a class="sourceLine" id="cb27-22" data-line-number="22"></a>
<a class="sourceLine" id="cb27-23" data-line-number="23">    <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(df, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> run, <span class="dt">y =</span> value)) <span class="op">+</span></a>
<a class="sourceLine" id="cb27-24" data-line-number="24"><span class="st">      </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_path">geom_line</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">color =</span> variable), <span class="dt">size =</span> <span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb27-25" data-line-number="25"><span class="st">      </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/scale_brewer">scale_color_brewer</a></span>(<span class="dt">type =</span> <span class="st">"div"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb27-26" data-line-number="26"><span class="st">      </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_minimal</a></span>()</a>
<a class="sourceLine" id="cb27-27" data-line-number="27"></a>
<a class="sourceLine" id="cb27-28" data-line-number="28">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb27-29" data-line-number="29"></a>
<a class="sourceLine" id="cb27-30" data-line-number="30">    <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(df, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> run, <span class="dt">y =</span> value)) <span class="op">+</span></a>
<a class="sourceLine" id="cb27-31" data-line-number="31"><span class="st">      </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_path">geom_line</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">color =</span> variable), <span class="dt">size =</span> <span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb27-32" data-line-number="32"><span class="st">      </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/scale_brewer">scale_color_brewer</a></span>(<span class="dt">type =</span> <span class="st">"qual"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb27-33" data-line-number="33"><span class="st">      </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_minimal</a></span>()</a>
<a class="sourceLine" id="cb27-34" data-line-number="34"></a>
<a class="sourceLine" id="cb27-35" data-line-number="35">  }</a>
<a class="sourceLine" id="cb27-36" data-line-number="36"></a>
<a class="sourceLine" id="cb27-37" data-line-number="37">}</a></code></pre></div>
<p>This is the averaged functional image:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1"><span class="kw"><a href="http://www.rdocumentation.org/packages/neurobase/topics/ortho2">ortho2</a></span>(res<span class="op">$</span>mean_func)</a></code></pre></div>
<p><img src="img/mean_func.png" width="640"></p>
<p>This is the connectome, the normalized correlation matrix representing a graph whose nodes are regions of interest and edge strength is given by the correlation between the time series of the regions.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1"><span class="kw">plot_matrix</span>(res<span class="op">$</span>cormat)</a></code></pre></div>
<p><img src="img/cormat.png" width="640"></p>
<p>We could plot the computed averaged time series for several regions of interest:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1">roi_names &lt;-<span class="st"> </span><span class="kw"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_tsv</a></span>(<span class="kw">file.path</span>(<span class="st">"."</span>, <span class="st">"resources"</span>,</a>
<a class="sourceLine" id="cb30-2" data-line-number="2">                                       <span class="st">"rsfMRI"</span>, <span class="st">"data"</span>,</a>
<a class="sourceLine" id="cb30-3" data-line-number="3">                                       <span class="st">"aal_MNI_V4.txt"</span>),</a>
<a class="sourceLine" id="cb30-4" data-line-number="4">                             <span class="dt">skip =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb30-5" data-line-number="5">                             <span class="dt">col_names =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb30-6" data-line-number="6">                             <span class="dt">col_types =</span> <span class="kw"><a href="https://readr.tidyverse.org/reference/cols.html">cols</a></span>())</a>
<a class="sourceLine" id="cb30-7" data-line-number="7"></a>
<a class="sourceLine" id="cb30-8" data-line-number="8"><span class="kw">colnames</span>(roi_names) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"index"</span>, <span class="st">"name"</span>)</a>
<a class="sourceLine" id="cb30-9" data-line-number="9"></a>
<a class="sourceLine" id="cb30-10" data-line-number="10">time_series &lt;-<span class="st"> </span><span class="kw">t</span>(res<span class="op">$</span>ts)</a>
<a class="sourceLine" id="cb30-11" data-line-number="11"><span class="kw">rownames</span>(time_series) &lt;-<span class="st"> </span>roi_names<span class="op">$</span>name</a>
<a class="sourceLine" id="cb30-12" data-line-number="12"></a>
<a class="sourceLine" id="cb30-13" data-line-number="13"><span class="kw">plot_time_series</span>(time_series[<span class="kw">c</span>(<span class="dv">29</span><span class="op">:</span><span class="dv">30</span>, <span class="dv">41</span><span class="op">:</span><span class="dv">42</span>), ])</a></code></pre></div>
<p><img src="img/ts.png" width="640"></p>
<p>We could compute which two regions have the greater correlation and plot their time series:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1"><span class="co"># Which two components have the greater correlation</span></a>
<a class="sourceLine" id="cb31-2" data-line-number="2">my_ind &lt;-<span class="st"> </span>res<span class="op">$</span>cormat <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb31-3" data-line-number="3"><span class="st">  </span><span class="kw">which.max</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb31-4" data-line-number="4"><span class="st">  </span><span class="kw">arrayInd</span>(<span class="dt">.dim =</span> <span class="kw">dim</span>(res<span class="op">$</span>cormat))</a>
<a class="sourceLine" id="cb31-5" data-line-number="5"></a>
<a class="sourceLine" id="cb31-6" data-line-number="6"><span class="kw">plot_time_series</span>(time_series[my_ind, ])</a></code></pre></div>
<p><img src="img/max_cor_ts.png" width="640"></p>
</div>
<div id="full-flow-log" class="section level2">
<h2 class="hasAnchor">
<a href="#full-flow-log" class="anchor"></a>Full Flow Log</h2>
<p>The <code>NIflow</code> object stores internally a log of all the processes that it goes through and the memory used to store its internal results:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" data-line-number="1">fmri_flow<span class="op">$</span><span class="kw">print_log</span>()</a></code></pre></div>
<pre><code>#&gt; (2019-04-29 16:11:04) [DEBUG] Adding process with inputs: BOLD and output(s): bold_slice_time
#&gt; (2019-04-29 16:11:04) [DEBUG] Adding process with inputs: bold_slice_time and output(s): motion_estimation
#&gt; (2019-04-29 16:11:04) [DEBUG] Adding process with inputs: motion_estimation and output(s): bold_motion_regressed
#&gt; (2019-04-29 16:11:05) [DEBUG] Adding process with inputs: bold_motion_regressed and output(s): mean_func
#&gt; (2019-04-29 16:11:05) [DEBUG] Adding process with inputs: mean_func and output(s): mean_func_brain
#&gt; (2019-04-29 16:11:05) [DEBUG] Adding process with inputs: bold_motion_regressed, mean_func_brain and output(s): bold_masked
#&gt; (2019-04-29 16:11:05) [DEBUG] Adding process with inputs: T1 and output(s): T1_brain
#&gt; (2019-04-29 16:11:05) [DEBUG] Adding process with inputs: T1_brain, bold_masked and output(s): all_normalized
#&gt; (2019-04-29 16:11:05) [DEBUG] Adding process with inputs: all_normalized and output(s): t12std
#&gt; (2019-04-29 16:11:05) [DEBUG] Adding process with inputs: all_normalized and output(s): func2std
#&gt; (2019-04-29 16:11:05) [DEBUG] Adding process with inputs: func2std and output(s): func2std_out_wm_csf
#&gt; (2019-04-29 16:11:05) [DEBUG] Adding process with inputs: func2std_out_wm_csf, TR and output(s): func_filtered
#&gt; (2019-04-29 16:11:06) [DEBUG] Adding process with inputs: func_filtered, atlas and output(s): ts
#&gt; (2019-04-29 16:11:06) [DEBUG] Adding process with inputs: ts and output(s): cormat
#&gt; (2019-04-29 16:11:08) [DEBUG] Reading input T1 from file ./resources/rsfMRI/anat.nii.gz
#&gt; (2019-04-29 16:11:14) [DEBUG] Reading input BOLD from file ./resources/rsfMRI/func.nii.gz
#&gt; (2019-04-29 16:11:18) [DEBUG] Using provided input TR
#&gt; (2019-04-29 16:11:18) [DEBUG] Reading input atlas from file ./resources/rsfMRI//data/aal_MNI_V4.nii
#&gt; (2019-04-29 16:11:19) [DEBUG] Memory used at init: 146.5 MB
#&gt; (2019-04-29 16:11:19) [DEBUG] Switching tempdir to: /Users/domingo/flow/fmri
#&gt; (2019-04-29 16:11:19) [DEBUG] Computing bold_slice_time...
#&gt; (2019-04-29 16:11:46) [DEBUG] Memory used after computation: 264.48 MB
#&gt; (2019-04-29 16:11:54) [DEBUG] Removed intermediate outputs: BOLD, t12std
#&gt; (2019-04-29 16:11:54) [DEBUG] Memory used after cleanup: 205.49 MB
#&gt; (2019-04-29 16:11:54) [DEBUG] Computing motion_estimation...
#&gt; (2019-04-29 16:12:34) [DEBUG] Memory used after computation: 323.47 MB
#&gt; (2019-04-29 16:12:56) [DEBUG] Removed intermediate outputs: bold_slice_time
#&gt; (2019-04-29 16:12:57) [DEBUG] Memory used after cleanup: 205.49 MB
#&gt; (2019-04-29 16:12:57) [DEBUG] Computing bold_motion_regressed...
#&gt; (2019-04-29 16:13:03) [DEBUG] Memory used after computation: 323.47 MB
#&gt; (2019-04-29 16:13:11) [DEBUG] Removed intermediate outputs: motion_estimation
#&gt; (2019-04-29 16:13:11) [DEBUG] Memory used after cleanup: 205.49 MB
#&gt; (2019-04-29 16:13:11) [DEBUG] Computing mean_func...
#&gt; (2019-04-29 16:13:11) [DEBUG] Memory used after computation: 206.68 MB
#&gt; (2019-04-29 16:13:11) [DEBUG] Computing T1_brain...
#&gt; (2019-04-29 16:13:30) [DEBUG] Memory used after computation: 290.57 MB
#&gt; (2019-04-29 16:13:32) [DEBUG] Removed intermediate outputs: T1
#&gt; (2019-04-29 16:13:32) [DEBUG] Memory used after cleanup: 206.68 MB
#&gt; (2019-04-29 16:13:32) [DEBUG] Computing mean_func_brain...
#&gt; (2019-04-29 16:13:34) [DEBUG] Memory used after computation: 207.86 MB
#&gt; (2019-04-29 16:13:34) [DEBUG] Computing bold_masked...
#&gt; (2019-04-29 16:13:49) [DEBUG] Memory used after computation: 325.84 MB
#&gt; (2019-04-29 16:13:53) [DEBUG] Removed intermediate outputs: bold_motion_regressed, mean_func_brain
#&gt; (2019-04-29 16:13:54) [DEBUG] Memory used after cleanup: 206.68 MB
#&gt; (2019-04-29 16:13:54) [DEBUG] Computing all_normalized...
#&gt; (2019-04-29 16:16:49) [DEBUG] Memory used after computation: 936.01 MB
#&gt; (2019-04-29 16:17:28) [DEBUG] Removed intermediate outputs: bold_masked, T1_brain
#&gt; (2019-04-29 16:17:29) [DEBUG] Memory used after cleanup: 734.15 MB
#&gt; (2019-04-29 16:17:29) [DEBUG] Computing func2std...
#&gt; (2019-04-29 16:17:29) [DEBUG] Memory used after computation: 1.46 GB
#&gt; (2019-04-29 16:18:19) [DEBUG] Computing func2std_out_wm_csf...
#&gt; (2019-04-29 16:19:52) [DEBUG] Memory used after computation: 2.18 GB
#&gt; (2019-04-29 16:20:50) [DEBUG] Removed intermediate outputs: func2std
#&gt; (2019-04-29 16:20:52) [DEBUG] Memory used after cleanup: 1.46 GB
#&gt; (2019-04-29 16:20:52) [DEBUG] Computing func_filtered...
#&gt; (2019-04-29 16:21:51) [DEBUG] Memory used after computation: 2.18 GB
#&gt; (2019-04-29 16:23:22) [DEBUG] Removed intermediate outputs: TR, func2std_out_wm_csf
#&gt; (2019-04-29 16:23:25) [DEBUG] Memory used after cleanup: 1.46 GB
#&gt; (2019-04-29 16:23:25) [DEBUG] Computing ts...
#&gt; (2019-04-29 16:24:30) [DEBUG] Memory used after computation: 1.46 GB
#&gt; (2019-04-29 16:24:30) [DEBUG] Removed intermediate outputs: atlas, func_filtered
#&gt; (2019-04-29 16:24:32) [DEBUG] Memory used after cleanup: 730.63 MB
#&gt; (2019-04-29 16:24:32) [DEBUG] Computing cormat...
#&gt; (2019-04-29 16:24:32) [DEBUG] Memory used after computation: 730.74 MB
#&gt; (2019-04-29 16:24:32) [DEBUG] Switching to base tempdir
#&gt; (2019-04-29 16:24:32) [DEBUG] Computed all results</code></pre>
</div>
</div>
<div id="annex-full-code" class="section level1">
<h1 class="hasAnchor">
<a href="#annex-full-code" class="anchor"></a>Annex: Full Code</h1>
<p>In this annex, we provide example code for the functional connectome workflow, which can be loaded and used to replicate the workflow and results given in this vignette.</p>
<p>When trying to use this code, take into account that several of the functions, just for the purposes of this vignette, have paths and filenames hardcoded. Please, change them when using it in your own computer.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" data-line-number="1"><span class="co"># slice time correction</span></a>
<a class="sourceLine" id="cb34-2" data-line-number="2">correct_slice_time &lt;-<span class="st"> </span><span class="cf">function</span>(bold) {</a>
<a class="sourceLine" id="cb34-3" data-line-number="3"></a>
<a class="sourceLine" id="cb34-4" data-line-number="4">  my_bold &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/neurobase/topics/checkimg-methods">checkimg</a></span>(bold)</a>
<a class="sourceLine" id="cb34-5" data-line-number="5"></a>
<a class="sourceLine" id="cb34-6" data-line-number="6">  bold_corrected &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/fslr/topics/fslslicetimer">fslslicetimer</a></span>(<span class="dt">file =</span> my_bold)</a>
<a class="sourceLine" id="cb34-7" data-line-number="7"></a>
<a class="sourceLine" id="cb34-8" data-line-number="8">  <span class="kw">return</span>(bold_corrected)</a>
<a class="sourceLine" id="cb34-9" data-line-number="9"></a>
<a class="sourceLine" id="cb34-10" data-line-number="10">}</a></code></pre></div>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1"><span class="co"># run motion correction</span></a>
<a class="sourceLine" id="cb35-2" data-line-number="2">correct_motion &lt;-<span class="st"> </span><span class="cf">function</span>(bold) {</a>
<a class="sourceLine" id="cb35-3" data-line-number="3"></a>
<a class="sourceLine" id="cb35-4" data-line-number="4">  my_bold &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/neurobase/topics/checkimg-methods">checkimg</a></span>(bold)</a>
<a class="sourceLine" id="cb35-5" data-line-number="5"></a>
<a class="sourceLine" id="cb35-6" data-line-number="6">  outfile &lt;-<span class="st"> </span><span class="kw">tempfile</span>()</a>
<a class="sourceLine" id="cb35-7" data-line-number="7"></a>
<a class="sourceLine" id="cb35-8" data-line-number="8">  res &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/fslr/topics/mcflirt">mcflirt</a></span>(<span class="dt">file =</span> my_bold,</a>
<a class="sourceLine" id="cb35-9" data-line-number="9">                       <span class="dt">outfile =</span> outfile,</a>
<a class="sourceLine" id="cb35-10" data-line-number="10">                       <span class="dt">opts =</span> <span class="st">"-plots"</span>)</a>
<a class="sourceLine" id="cb35-11" data-line-number="11"></a>
<a class="sourceLine" id="cb35-12" data-line-number="12">  pars &lt;-<span class="st"> </span><span class="kw"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_delim</a></span>(<span class="dt">file =</span> <span class="kw">paste0</span>(outfile, <span class="st">".par"</span>),</a>
<a class="sourceLine" id="cb35-13" data-line-number="13">                     <span class="dt">delim =</span> <span class="st">" "</span>,</a>
<a class="sourceLine" id="cb35-14" data-line-number="14">                     <span class="dt">col_names =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb35-15" data-line-number="15">                     <span class="dt">trim_ws =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb35-16" data-line-number="16">                     <span class="dt">col_types =</span> <span class="kw"><a href="https://readr.tidyverse.org/reference/cols.html">cols</a></span>())</a>
<a class="sourceLine" id="cb35-17" data-line-number="17"></a>
<a class="sourceLine" id="cb35-18" data-line-number="18">  pars_file &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="dt">pattern =</span> <span class="st">"  "</span>,</a>
<a class="sourceLine" id="cb35-19" data-line-number="19">                    <span class="dt">replacement =</span> <span class="st">" "</span>,</a>
<a class="sourceLine" id="cb35-20" data-line-number="20">                    <span class="dt">x =</span> <span class="kw"><a href="https://readr.tidyverse.org/reference/read_file.html">read_file</a></span>(<span class="kw">paste0</span>(outfile, <span class="st">".par"</span>)))</a>
<a class="sourceLine" id="cb35-21" data-line-number="21"></a>
<a class="sourceLine" id="cb35-22" data-line-number="22">  pars &lt;-<span class="st"> </span><span class="kw"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_delim</a></span>(pars_file,</a>
<a class="sourceLine" id="cb35-23" data-line-number="23">                     <span class="dt">delim =</span> <span class="st">" "</span>,</a>
<a class="sourceLine" id="cb35-24" data-line-number="24">                     <span class="dt">col_names =</span> <span class="ot">FALSE</span>)[, <span class="dv">1</span><span class="op">:</span><span class="dv">6</span>] <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb35-25" data-line-number="25"><span class="st">    </span><span class="kw">as.matrix</span>()</a>
<a class="sourceLine" id="cb35-26" data-line-number="26"></a>
<a class="sourceLine" id="cb35-27" data-line-number="27">  <span class="kw">return</span>(<span class="kw">list</span>(<span class="dt">image =</span> res, <span class="dt">pars =</span> pars))</a>
<a class="sourceLine" id="cb35-28" data-line-number="28"></a>
<a class="sourceLine" id="cb35-29" data-line-number="29">}</a>
<a class="sourceLine" id="cb35-30" data-line-number="30"></a>
<a class="sourceLine" id="cb35-31" data-line-number="31"><span class="co"># regressing out motion correction parameters</span></a>
<a class="sourceLine" id="cb35-32" data-line-number="32">regress_out_motion &lt;-<span class="st"> </span><span class="cf">function</span>(L) {</a>
<a class="sourceLine" id="cb35-33" data-line-number="33"></a>
<a class="sourceLine" id="cb35-34" data-line-number="34">  bold &lt;-<span class="st"> </span>L<span class="op">$</span>image</a>
<a class="sourceLine" id="cb35-35" data-line-number="35">  params &lt;-<span class="st"> </span>L<span class="op">$</span>pars</a>
<a class="sourceLine" id="cb35-36" data-line-number="36"></a>
<a class="sourceLine" id="cb35-37" data-line-number="37">  dims &lt;-<span class="st"> </span><span class="kw">dim</span>(bold)</a>
<a class="sourceLine" id="cb35-38" data-line-number="38">  my_fit &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim =</span> dims)</a>
<a class="sourceLine" id="cb35-39" data-line-number="39"></a>
<a class="sourceLine" id="cb35-40" data-line-number="40">  <span class="kw">dim</span>(bold) &lt;-<span class="st"> </span><span class="kw">c</span>(dims[<span class="dv">1</span>] <span class="op">*</span><span class="st"> </span>dims[<span class="dv">2</span>] <span class="op">*</span><span class="st"> </span>dims[<span class="dv">3</span>], dims[<span class="dv">4</span>])</a>
<a class="sourceLine" id="cb35-41" data-line-number="41">  tmp_mean &lt;-<span class="st"> </span><span class="kw">apply</span>(bold, <span class="dv">1</span>, mean)</a>
<a class="sourceLine" id="cb35-42" data-line-number="42">  <span class="kw">dim</span>(tmp_mean) &lt;-<span class="st"> </span>dims[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>]</a>
<a class="sourceLine" id="cb35-43" data-line-number="43">  <span class="kw">dim</span>(bold) &lt;-<span class="st"> </span>dims</a>
<a class="sourceLine" id="cb35-44" data-line-number="44"></a>
<a class="sourceLine" id="cb35-45" data-line-number="45">  <span class="cf">for</span> (z <span class="cf">in</span> <span class="kw">seq</span>(dims[<span class="dv">3</span>])) {</a>
<a class="sourceLine" id="cb35-46" data-line-number="46"></a>
<a class="sourceLine" id="cb35-47" data-line-number="47">    tmp_data &lt;-<span class="st"> </span>bold[, , z, ]</a>
<a class="sourceLine" id="cb35-48" data-line-number="48"></a>
<a class="sourceLine" id="cb35-49" data-line-number="49">    <span class="kw">dim</span>(tmp_data) &lt;-<span class="st"> </span><span class="kw">c</span>(dims[<span class="dv">1</span>] <span class="op">*</span><span class="st"> </span>dims[<span class="dv">2</span>], dims[<span class="dv">4</span>])</a>
<a class="sourceLine" id="cb35-50" data-line-number="50"></a>
<a class="sourceLine" id="cb35-51" data-line-number="51">    tmp_data &lt;-<span class="st"> </span><span class="kw">t</span>(tmp_data)</a>
<a class="sourceLine" id="cb35-52" data-line-number="52"></a>
<a class="sourceLine" id="cb35-53" data-line-number="53">    fit &lt;-<span class="st"> </span><span class="kw">lm</span>(tmp_data <span class="op">~</span><span class="st"> </span>params)</a>
<a class="sourceLine" id="cb35-54" data-line-number="54"></a>
<a class="sourceLine" id="cb35-55" data-line-number="55">    my_fit[, , z, ] &lt;-<span class="st"> </span><span class="kw">t</span>(fit<span class="op">$</span>residuals)</a>
<a class="sourceLine" id="cb35-56" data-line-number="56"></a>
<a class="sourceLine" id="cb35-57" data-line-number="57">  }</a>
<a class="sourceLine" id="cb35-58" data-line-number="58"></a>
<a class="sourceLine" id="cb35-59" data-line-number="59">  <span class="cf">for</span> (t <span class="cf">in</span> <span class="kw">seq</span>(dims[<span class="dv">4</span>])) {</a>
<a class="sourceLine" id="cb35-60" data-line-number="60"></a>
<a class="sourceLine" id="cb35-61" data-line-number="61">    my_fit[, , , t] &lt;-<span class="st"> </span>my_fit[, , , t] <span class="op">+</span><span class="st"> </span>tmp_mean</a>
<a class="sourceLine" id="cb35-62" data-line-number="62"></a>
<a class="sourceLine" id="cb35-63" data-line-number="63">  }</a>
<a class="sourceLine" id="cb35-64" data-line-number="64"></a>
<a class="sourceLine" id="cb35-65" data-line-number="65">  my_fit &lt;-<span class="st"> </span>my_fit <span class="op">-</span><span class="st"> </span><span class="kw">min</span>(my_fit)</a>
<a class="sourceLine" id="cb35-66" data-line-number="66">  my_fit &lt;-<span class="st"> </span>my_fit <span class="op">/</span><span class="st"> </span><span class="kw">max</span>(my_fit) <span class="op">*</span><span class="st"> </span><span class="dv">30000</span></a>
<a class="sourceLine" id="cb35-67" data-line-number="67"></a>
<a class="sourceLine" id="cb35-68" data-line-number="68">  <span class="kw">return</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/oro.nifti/topics/as.nifti">as.nifti</a></span>(my_fit, <span class="dt">value =</span> bold))</a>
<a class="sourceLine" id="cb35-69" data-line-number="69"></a>
<a class="sourceLine" id="cb35-70" data-line-number="70">}</a></code></pre></div>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" data-line-number="1"><span class="co">#first create mean_func</span></a>
<a class="sourceLine" id="cb36-2" data-line-number="2">compute_mean_func &lt;-<span class="st"> </span><span class="cf">function</span>(image) {</a>
<a class="sourceLine" id="cb36-3" data-line-number="3"></a>
<a class="sourceLine" id="cb36-4" data-line-number="4">  dims &lt;-<span class="st"> </span><span class="kw">dim</span>(image)</a>
<a class="sourceLine" id="cb36-5" data-line-number="5"></a>
<a class="sourceLine" id="cb36-6" data-line-number="6">  res &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim =</span> dims[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>])</a>
<a class="sourceLine" id="cb36-7" data-line-number="7"></a>
<a class="sourceLine" id="cb36-8" data-line-number="8">  <span class="cf">for</span> (t <span class="cf">in</span> <span class="kw">seq</span>(dims[<span class="dv">4</span>])) {</a>
<a class="sourceLine" id="cb36-9" data-line-number="9"></a>
<a class="sourceLine" id="cb36-10" data-line-number="10">    res &lt;-<span class="st"> </span>res <span class="op">+</span><span class="st"> </span>image[, , , t]</a>
<a class="sourceLine" id="cb36-11" data-line-number="11"></a>
<a class="sourceLine" id="cb36-12" data-line-number="12">  }</a>
<a class="sourceLine" id="cb36-13" data-line-number="13"></a>
<a class="sourceLine" id="cb36-14" data-line-number="14">  res &lt;-<span class="st"> </span>res <span class="op">/</span><span class="st"> </span>dims[<span class="dv">4</span>]</a>
<a class="sourceLine" id="cb36-15" data-line-number="15"></a>
<a class="sourceLine" id="cb36-16" data-line-number="16">  <span class="kw">return</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/oro.nifti/topics/as.nifti">as.nifti</a></span>(res, <span class="dt">value =</span> image))</a>
<a class="sourceLine" id="cb36-17" data-line-number="17"></a>
<a class="sourceLine" id="cb36-18" data-line-number="18">}</a>
<a class="sourceLine" id="cb36-19" data-line-number="19"></a>
<a class="sourceLine" id="cb36-20" data-line-number="20"><span class="co">#now skull strip the mean</span></a>
<a class="sourceLine" id="cb36-21" data-line-number="21">skull_strip &lt;-<span class="st"> </span><span class="cf">function</span>(image) {</a>
<a class="sourceLine" id="cb36-22" data-line-number="22"></a>
<a class="sourceLine" id="cb36-23" data-line-number="23"></a>
<a class="sourceLine" id="cb36-24" data-line-number="24">  my_file &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/neurobase/topics/checkimg-methods">checkimg</a></span>(image)</a>
<a class="sourceLine" id="cb36-25" data-line-number="25">  res &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/fslr/topics/fslbet">fslbet</a></span>(<span class="dt">infile =</span> my_file, <span class="dt">opts =</span> <span class="st">"-m"</span>)</a>
<a class="sourceLine" id="cb36-26" data-line-number="26"></a>
<a class="sourceLine" id="cb36-27" data-line-number="27">  <span class="kw">return</span>(res)</a>
<a class="sourceLine" id="cb36-28" data-line-number="28"></a>
<a class="sourceLine" id="cb36-29" data-line-number="29">}</a>
<a class="sourceLine" id="cb36-30" data-line-number="30"></a>
<a class="sourceLine" id="cb36-31" data-line-number="31"><span class="co">#now mask full run by results</span></a>
<a class="sourceLine" id="cb36-32" data-line-number="32">mask_run &lt;-<span class="st"> </span><span class="cf">function</span>(image, mask) {</a>
<a class="sourceLine" id="cb36-33" data-line-number="33"></a>
<a class="sourceLine" id="cb36-34" data-line-number="34">  masked &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/fslr/topics/fslmask">fslmask</a></span>(<span class="dt">file =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/neurobase/topics/checkimg-methods">checkimg</a></span>(image),</a>
<a class="sourceLine" id="cb36-35" data-line-number="35">                    <span class="dt">mask =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/neurobase/topics/checkimg-methods">checkimg</a></span>(mask <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>))</a>
<a class="sourceLine" id="cb36-36" data-line-number="36"></a>
<a class="sourceLine" id="cb36-37" data-line-number="37">  <span class="kw">return</span>(masked)</a>
<a class="sourceLine" id="cb36-38" data-line-number="38"></a>
<a class="sourceLine" id="cb36-39" data-line-number="39">}</a></code></pre></div>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1"><span class="co"># normalize the data</span></a>
<a class="sourceLine" id="cb37-2" data-line-number="2">normalize_data &lt;-<span class="st"> </span><span class="cf">function</span>(t1_ss, bold_ss) {</a>
<a class="sourceLine" id="cb37-3" data-line-number="3"></a>
<a class="sourceLine" id="cb37-4" data-line-number="4">  fsldir &lt;-<span class="st"> </span><span class="kw">getOption</span>(<span class="st">"fsl.path"</span>)</a>
<a class="sourceLine" id="cb37-5" data-line-number="5">  flirtref &lt;-<span class="st"> </span><span class="kw">file.path</span>(fsldir, <span class="st">'data'</span>, <span class="st">'standard'</span>,</a>
<a class="sourceLine" id="cb37-6" data-line-number="6">                        <span class="st">'MNI152_T1_2mm_brain.nii.gz'</span>)</a>
<a class="sourceLine" id="cb37-7" data-line-number="7"></a>
<a class="sourceLine" id="cb37-8" data-line-number="8">  my_t1 &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/neurobase/topics/checkimg-methods">checkimg</a></span>(t1_ss)</a>
<a class="sourceLine" id="cb37-9" data-line-number="9">  my_bold &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/neurobase/topics/checkimg-methods">checkimg</a></span>(bold_ss)</a>
<a class="sourceLine" id="cb37-10" data-line-number="10"></a>
<a class="sourceLine" id="cb37-11" data-line-number="11">  res &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/fslr/topics/fslsplit">fslsplit</a></span>(<span class="dt">infile =</span> my_bold, <span class="dt">direction =</span> <span class="st">"t"</span>)</a>
<a class="sourceLine" id="cb37-12" data-line-number="12">  my_bold1 &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/neurobase/topics/checkimg-methods">checkimg</a></span>(res[[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb37-13" data-line-number="13"></a>
<a class="sourceLine" id="cb37-14" data-line-number="14">  func2t1_mat &lt;-<span class="st"> </span><span class="kw">tempfile</span>(<span class="dt">fileext =</span> <span class="st">".mat"</span>)</a>
<a class="sourceLine" id="cb37-15" data-line-number="15">  t12standard_mat &lt;-<span class="st"> </span><span class="kw">tempfile</span>(<span class="dt">fileext =</span> <span class="st">".mat"</span>)</a>
<a class="sourceLine" id="cb37-16" data-line-number="16">  t12func_mat &lt;-<span class="st"> </span><span class="kw">tempfile</span>(<span class="dt">fileext =</span> <span class="st">".mat"</span>)</a>
<a class="sourceLine" id="cb37-17" data-line-number="17">  standard2t1_mat &lt;-<span class="st"> </span><span class="kw">tempfile</span>(<span class="dt">fileext =</span> <span class="st">".mat"</span>)</a>
<a class="sourceLine" id="cb37-18" data-line-number="18">  func2standard_mat  &lt;-<span class="st"> </span><span class="kw">tempfile</span>(<span class="dt">fileext =</span> <span class="st">".mat"</span>)</a>
<a class="sourceLine" id="cb37-19" data-line-number="19"></a>
<a class="sourceLine" id="cb37-20" data-line-number="20">  <span class="co">#first flirt the func to the t1</span></a>
<a class="sourceLine" id="cb37-21" data-line-number="21">  tmp &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/fslr/topics/flirt">flirt</a></span>(<span class="dt">infile =</span> my_bold1,</a>
<a class="sourceLine" id="cb37-22" data-line-number="22">                     <span class="dt">reffile =</span> my_t1,</a>
<a class="sourceLine" id="cb37-23" data-line-number="23">                     <span class="dt">omat =</span> func2t1_mat,</a>
<a class="sourceLine" id="cb37-24" data-line-number="24">                     <span class="dt">opts =</span> <span class="st">"-cost corratio -dof 6 -searchrx -90 90 -searchry -90 90 -searchrz -90 90 -interp trilinear"</span>)</a>
<a class="sourceLine" id="cb37-25" data-line-number="25"></a>
<a class="sourceLine" id="cb37-26" data-line-number="26">  <span class="co">#invert the mat</span></a>
<a class="sourceLine" id="cb37-27" data-line-number="27"></a>
<a class="sourceLine" id="cb37-28" data-line-number="28">  cmd_base &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/fslr/topics/get.fsl">get.fsl</a></span>()</a>
<a class="sourceLine" id="cb37-29" data-line-number="29"></a>
<a class="sourceLine" id="cb37-30" data-line-number="30">  cmd &lt;-<span class="st"> </span><span class="kw">paste0</span>(cmd_base,</a>
<a class="sourceLine" id="cb37-31" data-line-number="31">                <span class="st">"convert_xfm -inverse "</span>, func2t1_mat,</a>
<a class="sourceLine" id="cb37-32" data-line-number="32">                <span class="st">" -omat "</span>, t12func_mat)</a>
<a class="sourceLine" id="cb37-33" data-line-number="33"></a>
<a class="sourceLine" id="cb37-34" data-line-number="34">  <span class="kw">system</span>(cmd, <span class="dt">intern =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb37-35" data-line-number="35"></a>
<a class="sourceLine" id="cb37-36" data-line-number="36">  <span class="co">#flirt the t1 to standard</span></a>
<a class="sourceLine" id="cb37-37" data-line-number="37">  t12std_img &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/fslr/topics/flirt">flirt</a></span>(<span class="dt">infile =</span> my_t1,</a>
<a class="sourceLine" id="cb37-38" data-line-number="38">                     <span class="dt">reffile =</span> flirtref,</a>
<a class="sourceLine" id="cb37-39" data-line-number="39">                     <span class="dt">omat =</span> t12standard_mat,</a>
<a class="sourceLine" id="cb37-40" data-line-number="40">                     <span class="dt">opts =</span> <span class="st">" -cost corratio -dof 12 -searchrx -90 90 -searchry -90 90 -searchrz -90 90 -interp trilinear"</span>)</a>
<a class="sourceLine" id="cb37-41" data-line-number="41"></a>
<a class="sourceLine" id="cb37-42" data-line-number="42">  <span class="co">#invert the mat</span></a>
<a class="sourceLine" id="cb37-43" data-line-number="43">  cmd &lt;-<span class="st"> </span><span class="kw">paste0</span>(cmd_base,</a>
<a class="sourceLine" id="cb37-44" data-line-number="44">                <span class="st">"convert_xfm -inverse "</span>, t12standard_mat,</a>
<a class="sourceLine" id="cb37-45" data-line-number="45">                <span class="st">" -omat "</span>, standard2t1_mat)</a>
<a class="sourceLine" id="cb37-46" data-line-number="46"></a>
<a class="sourceLine" id="cb37-47" data-line-number="47">  <span class="kw">system</span>(cmd, <span class="dt">intern =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb37-48" data-line-number="48"></a>
<a class="sourceLine" id="cb37-49" data-line-number="49">  <span class="co">#compute the func2standard mat</span></a>
<a class="sourceLine" id="cb37-50" data-line-number="50"></a>
<a class="sourceLine" id="cb37-51" data-line-number="51">  cmd &lt;-<span class="st"> </span><span class="kw">paste0</span>(cmd_base,</a>
<a class="sourceLine" id="cb37-52" data-line-number="52">                <span class="st">"convert_xfm -omat "</span>, func2standard_mat,</a>
<a class="sourceLine" id="cb37-53" data-line-number="53">                <span class="st">" -concat "</span>, t12standard_mat, <span class="st">" "</span>, func2t1_mat)</a>
<a class="sourceLine" id="cb37-54" data-line-number="54"></a>
<a class="sourceLine" id="cb37-55" data-line-number="55">  <span class="kw">system</span>(cmd, <span class="dt">intern =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb37-56" data-line-number="56"></a>
<a class="sourceLine" id="cb37-57" data-line-number="57">  <span class="co">#apply the transform</span></a>
<a class="sourceLine" id="cb37-58" data-line-number="58">  func2std_img &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/fslr/topics/flirt_apply">flirt_apply</a></span>(<span class="dt">infile =</span> my_bold,</a>
<a class="sourceLine" id="cb37-59" data-line-number="59">                                    <span class="dt">reffile =</span> flirtref,</a>
<a class="sourceLine" id="cb37-60" data-line-number="60">                                    <span class="dt">initmat =</span> func2standard_mat,</a>
<a class="sourceLine" id="cb37-61" data-line-number="61">                                    <span class="dt">opts =</span> <span class="st">" -interp trilinear"</span>)</a>
<a class="sourceLine" id="cb37-62" data-line-number="62"></a>
<a class="sourceLine" id="cb37-63" data-line-number="63">  <span class="kw">return</span>(<span class="kw">list</span>(<span class="dt">t12std_img =</span> t12std_img,</a>
<a class="sourceLine" id="cb37-64" data-line-number="64">              <span class="dt">func2std_img =</span> func2std_img))</a>
<a class="sourceLine" id="cb37-65" data-line-number="65"></a>
<a class="sourceLine" id="cb37-66" data-line-number="66">}</a>
<a class="sourceLine" id="cb37-67" data-line-number="67"></a>
<a class="sourceLine" id="cb37-68" data-line-number="68">get_t12std &lt;-<span class="st"> </span><span class="cf">function</span>(L) L<span class="op">$</span>t12std_img</a>
<a class="sourceLine" id="cb37-69" data-line-number="69">get_func2std &lt;-<span class="st"> </span><span class="cf">function</span>(L) L<span class="op">$</span>func2std_img</a></code></pre></div>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb38-1" data-line-number="1"><span class="co"># regress out WM/CSF</span></a>
<a class="sourceLine" id="cb38-2" data-line-number="2">regress_out_wm_csf &lt;-<span class="st"> </span><span class="cf">function</span>(func2std_img) {</a>
<a class="sourceLine" id="cb38-3" data-line-number="3"></a>
<a class="sourceLine" id="cb38-4" data-line-number="4">  base_dir &lt;-<span class="st"> "./resources/rsfMRI/"</span></a>
<a class="sourceLine" id="cb38-5" data-line-number="5"></a>
<a class="sourceLine" id="cb38-6" data-line-number="6">  refwm &lt;-<span class="st"> </span><span class="kw">file.path</span>(base_dir, <span class="st">'data'</span>,</a>
<a class="sourceLine" id="cb38-7" data-line-number="7">                     <span class="st">'MNI152_T1_2mm_brain_pve_2.nii.gz'</span>)</a>
<a class="sourceLine" id="cb38-8" data-line-number="8">  refcsf &lt;-<span class="st"> </span><span class="kw">file.path</span>(base_dir, <span class="st">'data'</span>,</a>
<a class="sourceLine" id="cb38-9" data-line-number="9">                      <span class="st">'MNI152_T1_2mm_brain_pve_0.nii.gz'</span>)</a>
<a class="sourceLine" id="cb38-10" data-line-number="10"></a>
<a class="sourceLine" id="cb38-11" data-line-number="11">  wmout &lt;-<span class="st"> </span><span class="kw">tempfile</span>(<span class="dt">fileext =</span> <span class="st">".txt"</span>)</a>
<a class="sourceLine" id="cb38-12" data-line-number="12">  csfout &lt;-<span class="st"> </span><span class="kw">tempfile</span>(<span class="dt">fileext =</span> <span class="st">".txt"</span>)</a>
<a class="sourceLine" id="cb38-13" data-line-number="13"></a>
<a class="sourceLine" id="cb38-14" data-line-number="14">  cmd_base &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/fslr/topics/get.fsl">get.fsl</a></span>()</a>
<a class="sourceLine" id="cb38-15" data-line-number="15"></a>
<a class="sourceLine" id="cb38-16" data-line-number="16">  <span class="cf">if</span> (<span class="kw"><a href="http://www.rdocumentation.org/packages/oro.nifti/topics/is_nifti">is.nifti</a></span>(func2std_img)) {</a>
<a class="sourceLine" id="cb38-17" data-line-number="17"></a>
<a class="sourceLine" id="cb38-18" data-line-number="18">    img &lt;-<span class="st"> </span><span class="kw">tempfile</span>(<span class="dt">fileext =</span> <span class="st">".nii.gz"</span>)</a>
<a class="sourceLine" id="cb38-19" data-line-number="19">    <span class="kw"><a href="http://www.rdocumentation.org/packages/neurobase/topics/writeNIfTI2">writenii</a></span>(func2std_img, <span class="dt">filename =</span> img, <span class="dt">dtype =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb38-20" data-line-number="20"></a>
<a class="sourceLine" id="cb38-21" data-line-number="21">  }</a>
<a class="sourceLine" id="cb38-22" data-line-number="22">  <span class="co"># img &lt;- checkimg(func2std_img)</span></a>
<a class="sourceLine" id="cb38-23" data-line-number="23"></a>
<a class="sourceLine" id="cb38-24" data-line-number="24">  <span class="co">#mean time series for wm</span></a>
<a class="sourceLine" id="cb38-25" data-line-number="25">  cmd &lt;-<span class="st"> </span><span class="kw">paste0</span>(cmd_base,</a>
<a class="sourceLine" id="cb38-26" data-line-number="26">                <span class="st">"fslmeants -i "</span>, img,</a>
<a class="sourceLine" id="cb38-27" data-line-number="27">                <span class="st">" -m "</span>, refwm, <span class="st">" -o "</span>, wmout)</a>
<a class="sourceLine" id="cb38-28" data-line-number="28"></a>
<a class="sourceLine" id="cb38-29" data-line-number="29">  <span class="kw">system</span>(cmd, <span class="dt">intern =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb38-30" data-line-number="30"></a>
<a class="sourceLine" id="cb38-31" data-line-number="31">  <span class="co">#mean time series for csf</span></a>
<a class="sourceLine" id="cb38-32" data-line-number="32">  cmd &lt;-<span class="st"> </span><span class="kw">paste0</span>(cmd_base,</a>
<a class="sourceLine" id="cb38-33" data-line-number="33">                <span class="st">"fslmeants -i "</span>, img,</a>
<a class="sourceLine" id="cb38-34" data-line-number="34">                <span class="st">" -m "</span>, refcsf, <span class="st">" -o "</span>, csfout)</a>
<a class="sourceLine" id="cb38-35" data-line-number="35"></a>
<a class="sourceLine" id="cb38-36" data-line-number="36">  <span class="kw">system</span>(cmd, <span class="dt">intern =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb38-37" data-line-number="37"></a>
<a class="sourceLine" id="cb38-38" data-line-number="38">  wm_ts &lt;-<span class="st"> </span><span class="kw">read.csv</span>(wmout, <span class="dt">header =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unlist</span>()</a>
<a class="sourceLine" id="cb38-39" data-line-number="39">  csf_ts &lt;-<span class="st"> </span><span class="kw">read.csv</span>(csfout, <span class="dt">header =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unlist</span>()</a>
<a class="sourceLine" id="cb38-40" data-line-number="40"></a>
<a class="sourceLine" id="cb38-41" data-line-number="41">  dims &lt;-<span class="st"> </span><span class="kw">dim</span>(func2std_img)</a>
<a class="sourceLine" id="cb38-42" data-line-number="42"></a>
<a class="sourceLine" id="cb38-43" data-line-number="43">  my_fit &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim =</span> dims)</a>
<a class="sourceLine" id="cb38-44" data-line-number="44"></a>
<a class="sourceLine" id="cb38-45" data-line-number="45">  <span class="co">#slice by slice:</span></a>
<a class="sourceLine" id="cb38-46" data-line-number="46">  <span class="cf">for</span> (z <span class="cf">in</span> <span class="kw">seq</span>(dims[<span class="dv">3</span>])) {</a>
<a class="sourceLine" id="cb38-47" data-line-number="47"></a>
<a class="sourceLine" id="cb38-48" data-line-number="48">    tmp_data &lt;-<span class="st"> </span>func2std_img[, , z, ]</a>
<a class="sourceLine" id="cb38-49" data-line-number="49"></a>
<a class="sourceLine" id="cb38-50" data-line-number="50">    <span class="kw">dim</span>(tmp_data) &lt;-<span class="st"> </span><span class="kw">c</span>(dims[<span class="dv">1</span>] <span class="op">*</span><span class="st"> </span>dims[<span class="dv">2</span>], dims[<span class="dv">4</span>])</a>
<a class="sourceLine" id="cb38-51" data-line-number="51">    tmp_data &lt;-<span class="st"> </span><span class="kw">t</span>(tmp_data)</a>
<a class="sourceLine" id="cb38-52" data-line-number="52"></a>
<a class="sourceLine" id="cb38-53" data-line-number="53">    <span class="co"># regress out wm</span></a>
<a class="sourceLine" id="cb38-54" data-line-number="54">    fit &lt;-<span class="st"> </span><span class="kw">lm</span>(tmp_data <span class="op">~</span><span class="st"> </span>wm_ts)</a>
<a class="sourceLine" id="cb38-55" data-line-number="55"></a>
<a class="sourceLine" id="cb38-56" data-line-number="56">    tmp_data &lt;-<span class="st"> </span>fit<span class="op">$</span>residuals</a>
<a class="sourceLine" id="cb38-57" data-line-number="57"></a>
<a class="sourceLine" id="cb38-58" data-line-number="58">    <span class="co"># regress out csf</span></a>
<a class="sourceLine" id="cb38-59" data-line-number="59">    fit &lt;-<span class="st"> </span><span class="kw">lm</span>(tmp_data <span class="op">~</span><span class="st"> </span>csf_ts)</a>
<a class="sourceLine" id="cb38-60" data-line-number="60"></a>
<a class="sourceLine" id="cb38-61" data-line-number="61">    my_fit[, , z, ] &lt;-<span class="st"> </span><span class="kw">t</span>(fit<span class="op">$</span>residuals)</a>
<a class="sourceLine" id="cb38-62" data-line-number="62"></a>
<a class="sourceLine" id="cb38-63" data-line-number="63">  }</a>
<a class="sourceLine" id="cb38-64" data-line-number="64"></a>
<a class="sourceLine" id="cb38-65" data-line-number="65">  <span class="kw">return</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/oro.nifti/topics/as.nifti">as.nifti</a></span>(my_fit, <span class="dt">value =</span> func2std_img))</a>
<a class="sourceLine" id="cb38-66" data-line-number="66"></a>
<a class="sourceLine" id="cb38-67" data-line-number="67">}</a></code></pre></div>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" data-line-number="1"><span class="co"># bandpass filter</span></a>
<a class="sourceLine" id="cb39-2" data-line-number="2">filter_func &lt;-<span class="st"> </span><span class="cf">function</span>(func, tr) {</a>
<a class="sourceLine" id="cb39-3" data-line-number="3"></a>
<a class="sourceLine" id="cb39-4" data-line-number="4">  dims &lt;-<span class="st"> </span><span class="kw">dim</span>(func)</a>
<a class="sourceLine" id="cb39-5" data-line-number="5"></a>
<a class="sourceLine" id="cb39-6" data-line-number="6">  n_voxels &lt;-<span class="st"> </span>dims[<span class="dv">1</span>] <span class="op">*</span><span class="st"> </span>dims[<span class="dv">2</span>] <span class="op">*</span><span class="st"> </span>dims[<span class="dv">3</span>]</a>
<a class="sourceLine" id="cb39-7" data-line-number="7"></a>
<a class="sourceLine" id="cb39-8" data-line-number="8">  <span class="kw">dim</span>(func) &lt;-<span class="st"> </span><span class="kw">c</span>(n_voxels, dims[<span class="dv">4</span>])</a>
<a class="sourceLine" id="cb39-9" data-line-number="9"></a>
<a class="sourceLine" id="cb39-10" data-line-number="10">  func_mat &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>,</a>
<a class="sourceLine" id="cb39-11" data-line-number="11">                     <span class="dt">nrow =</span> dims[<span class="dv">4</span>],</a>
<a class="sourceLine" id="cb39-12" data-line-number="12">                     <span class="dt">ncol =</span> n_voxels)</a>
<a class="sourceLine" id="cb39-13" data-line-number="13"></a>
<a class="sourceLine" id="cb39-14" data-line-number="14">  chunks &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">1</span>, n_voxels, <span class="dt">by =</span> <span class="dv">10000</span>)</a>
<a class="sourceLine" id="cb39-15" data-line-number="15"></a>
<a class="sourceLine" id="cb39-16" data-line-number="16">  <span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq_along</span>(chunks)) {</a>
<a class="sourceLine" id="cb39-17" data-line-number="17"></a>
<a class="sourceLine" id="cb39-18" data-line-number="18">    init &lt;-<span class="st"> </span>chunks[i]</a>
<a class="sourceLine" id="cb39-19" data-line-number="19">    end &lt;-<span class="st"> </span><span class="kw">ifelse</span>(i <span class="op">&lt;</span><span class="st"> </span><span class="kw">length</span>(chunks),</a>
<a class="sourceLine" id="cb39-20" data-line-number="20">                  chunks[i <span class="op">+</span><span class="st"> </span><span class="dv">1</span>] <span class="op">-</span><span class="st"> </span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb39-21" data-line-number="21">                  n_voxels)</a>
<a class="sourceLine" id="cb39-22" data-line-number="22"></a>
<a class="sourceLine" id="cb39-23" data-line-number="23">    func_mat[, init<span class="op">:</span>end] &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ANTsR/topics/frequencyFilterfMRI">frequencyFilterfMRI</a></span>(func[init<span class="op">:</span>end, ] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">t</span>(),</a>
<a class="sourceLine" id="cb39-24" data-line-number="24">                                               tr)</a>
<a class="sourceLine" id="cb39-25" data-line-number="25"></a>
<a class="sourceLine" id="cb39-26" data-line-number="26">  }</a>
<a class="sourceLine" id="cb39-27" data-line-number="27"></a>
<a class="sourceLine" id="cb39-28" data-line-number="28">  func<span class="op">@</span>.Data &lt;-<span class="st"> </span>func_mat <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">t</span>()</a>
<a class="sourceLine" id="cb39-29" data-line-number="29">  <span class="kw">dim</span>(func<span class="op">@</span>.Data) &lt;-<span class="st"> </span>dims</a>
<a class="sourceLine" id="cb39-30" data-line-number="30"></a>
<a class="sourceLine" id="cb39-31" data-line-number="31">  <span class="kw">return</span>(func)</a>
<a class="sourceLine" id="cb39-32" data-line-number="32"></a>
<a class="sourceLine" id="cb39-33" data-line-number="33">}</a></code></pre></div>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" data-line-number="1"><span class="co"># do the parcellation</span></a>
<a class="sourceLine" id="cb40-2" data-line-number="2">extract_time_series &lt;-<span class="st"> </span><span class="cf">function</span>(bold, corr_label) {</a>
<a class="sourceLine" id="cb40-3" data-line-number="3"></a>
<a class="sourceLine" id="cb40-4" data-line-number="4">  cmd_base &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/fslr/topics/get.fsl">get.fsl</a></span>()</a>
<a class="sourceLine" id="cb40-5" data-line-number="5"></a>
<a class="sourceLine" id="cb40-6" data-line-number="6">  corr_label &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/neurobase/topics/checkimg-methods">checkimg</a></span>(corr_label)</a>
<a class="sourceLine" id="cb40-7" data-line-number="7"></a>
<a class="sourceLine" id="cb40-8" data-line-number="8">  <span class="cf">if</span> (<span class="kw"><a href="http://www.rdocumentation.org/packages/oro.nifti/topics/is_nifti">is.nifti</a></span>(bold)) {</a>
<a class="sourceLine" id="cb40-9" data-line-number="9"></a>
<a class="sourceLine" id="cb40-10" data-line-number="10">    img &lt;-<span class="st"> </span><span class="kw">tempfile</span>(<span class="dt">fileext =</span> <span class="st">".nii.gz"</span>)</a>
<a class="sourceLine" id="cb40-11" data-line-number="11">    <span class="kw"><a href="http://www.rdocumentation.org/packages/neurobase/topics/writeNIfTI2">writenii</a></span>(bold, <span class="dt">filename =</span> img, <span class="dt">dtype =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb40-12" data-line-number="12"></a>
<a class="sourceLine" id="cb40-13" data-line-number="13">  }</a>
<a class="sourceLine" id="cb40-14" data-line-number="14"></a>
<a class="sourceLine" id="cb40-15" data-line-number="15">  corrtxt &lt;-<span class="st"> </span><span class="kw">tempfile</span>(<span class="dt">fileext =</span> <span class="st">".txt"</span>)</a>
<a class="sourceLine" id="cb40-16" data-line-number="16"></a>
<a class="sourceLine" id="cb40-17" data-line-number="17">  cmd &lt;-<span class="st"> </span><span class="kw">paste0</span>(cmd_base,</a>
<a class="sourceLine" id="cb40-18" data-line-number="18">                <span class="st">"fslmeants -i "</span>, img,</a>
<a class="sourceLine" id="cb40-19" data-line-number="19">                <span class="st">" --label="</span>, corr_label, <span class="st">" -o "</span>, corrtxt)</a>
<a class="sourceLine" id="cb40-20" data-line-number="20"></a>
<a class="sourceLine" id="cb40-21" data-line-number="21">  <span class="kw">system</span>(cmd, <span class="dt">intern =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb40-22" data-line-number="22"></a>
<a class="sourceLine" id="cb40-23" data-line-number="23">  ts &lt;-<span class="st"> </span><span class="kw">read.table</span>(corrtxt, <span class="dt">header =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.matrix</span>()</a>
<a class="sourceLine" id="cb40-24" data-line-number="24"></a>
<a class="sourceLine" id="cb40-25" data-line-number="25">  <span class="kw">return</span>(ts)</a>
<a class="sourceLine" id="cb40-26" data-line-number="26"></a>
<a class="sourceLine" id="cb40-27" data-line-number="27">}</a>
<a class="sourceLine" id="cb40-28" data-line-number="28"></a>
<a class="sourceLine" id="cb40-29" data-line-number="29"><span class="co"># do the correlation</span></a>
<a class="sourceLine" id="cb40-30" data-line-number="30">compute_correlation &lt;-<span class="st"> </span><span class="cf">function</span>(time_series) {</a>
<a class="sourceLine" id="cb40-31" data-line-number="31"></a>
<a class="sourceLine" id="cb40-32" data-line-number="32">  r &lt;-<span class="st"> </span><span class="kw">cor</span>(time_series)</a>
<a class="sourceLine" id="cb40-33" data-line-number="33"></a>
<a class="sourceLine" id="cb40-34" data-line-number="34">  zr &lt;-<span class="st"> </span><span class="fl">0.5</span> <span class="op">*</span><span class="st"> </span><span class="kw">log</span>((<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>r) <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>r))</a>
<a class="sourceLine" id="cb40-35" data-line-number="35"></a>
<a class="sourceLine" id="cb40-36" data-line-number="36">  zr[<span class="op">!</span><span class="kw">is.finite</span>(zr)] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb40-37" data-line-number="37"></a>
<a class="sourceLine" id="cb40-38" data-line-number="38">  <span class="kw">return</span>(zr)</a>
<a class="sourceLine" id="cb40-39" data-line-number="39"></a>
<a class="sourceLine" id="cb40-40" data-line-number="40">}</a></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#objective">Objective</a></li>
      <li>
<a href="#requirements">Requirements</a><ul class="nav nav-pills nav-stacked">
<li><a href="#packages">Packages</a></li>
      <li><a href="#other-resources">Other Resources</a></li>
      </ul>
</li>
      <li>
<a href="#fmri-processing">fMRI Processing</a><ul class="nav nav-pills nav-stacked">
<li><a href="#slice-time-correction">Slice Time Correction</a></li>
      <li><a href="#motion-correction">Motion Correction</a></li>
      <li><a href="#skull-strip-functional-image">Skull Strip Functional Image</a></li>
      <li><a href="#normalize-data">Normalize data</a></li>
      <li><a href="#regress-out-wm-and-csf-signals">Regress out WM and CSF Signals</a></li>
      <li><a href="#bandpass-filter">Bandpass Filter</a></li>
      <li><a href="#extract-time-series-and-compute-correlation">Extract Time-Series and Compute Correlation</a></li>
      </ul>
</li>
      <li><a href="#final-flow">Final Flow</a></li>
      <li>
<a href="#example">Example</a><ul class="nav nav-pills nav-stacked">
<li><a href="#code">Code</a></li>
      <li><a href="#images">Images</a></li>
      <li><a href="#full-flow-log">Full Flow Log</a></li>
      </ul>
</li>
      <li><a href="#annex-full-code">Annex: Full Code</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Domingo Lopez-Rodriguez.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
