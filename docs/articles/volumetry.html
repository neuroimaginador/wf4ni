<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using <code>wf4ni</code> to Build a Volumetry Flow • wf4ni</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using &lt;code&gt;wf4ni&lt;/code&gt; to Build a Volumetry Flow">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">wf4ni</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/wf4ni.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/rsfmri.html">Using `wf4ni` for Resting State fMRI processing</a>
    </li>
    <li>
      <a href="../articles/tractography.html">Using `wf4ni` to Compute Tractography</a>
    </li>
    <li>
      <a href="../articles/volumetry.html">Using `wf4ni` to Build a Volumetry Flow</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/neuroimaginador/wf4ni">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Using <code>wf4ni</code> to Build a Volumetry Flow</h1>
                        <h4 class="author">Domingo López-Rodríguez</h4>
            
            <h4 class="date">2019-05-07</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/neuroimaginador/wf4ni/blob/master/vignettes/volumetry.Rmd"><code>vignettes/volumetry.Rmd</code></a></small>
      <div class="hidden name"><code>volumetry.Rmd</code></div>

    </div>

    
    
<div id="objective" class="section level1">
<h1 class="hasAnchor">
<a href="#objective" class="anchor"></a>Objective</h1>
<p>In this vignette, we’re going to develop a volumetry pipeline (workflow) to quantify the volume of subcortical nuclei, using the <code>wf4ni</code> package.</p>
<p>The main steps in this pipeline will be:</p>
<ul>
<li>Reorientation of the input image into MNI space.</li>
<li>Correction of intensity inhomogeneities.</li>
<li>Removal of non-brain tissue.</li>
<li>Segmentation of different tissue types.</li>
<li>Anatomical parcellation, that is, delimitation of different regions of interest.</li>
<li>Quantification of volume of those regions.</li>
</ul>
<p>To demonstrate the flexibility of <code>wf4ni</code>, we’ll use different <code>R</code> packages to perform several of the above steps.</p>
<p>It must be noted that the philosophy of <code>wf4ni</code> is to separate the pipeline logic from its implementation. So, the same workflow could be used just changing, if needed, the implementation of any (or all) of the steps above.</p>
<p>The organization of this vignette is as follows. First, we’ll describe the dependencies or packages needed to run the workflow. Later, we’ll describe the workflow, step by step, without presenting the actual implementation of the functions used. Then, we’ll use some sample data to run an experiment with the workflow, presenting its results. We’ll end the vignette with an annex in which we’ll present the actual implementation of the functions.</p>
</div>
<div id="requirements" class="section level1">
<h1 class="hasAnchor">
<a href="#requirements" class="anchor"></a>Requirements</h1>
<p>We consider two types of requirements: packages needed to perform the key steps in the workflow and data which may be necessary at any step of the computation.</p>
<div id="packages" class="section level2">
<h2 class="hasAnchor">
<a href="#packages" class="anchor"></a>Packages</h2>
<p>First, obviously, the <code>wf4ni</code> package:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(wf4ni)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="co">#&gt; Attaching package: 'wf4ni'</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="co">#&gt; The following object is masked from 'package:base':</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="co">#&gt;     merge</span></a></code></pre></div>
<p>Other packages needed at some point of the workflow are loaded by:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="kw">library</span>(ANTsRCore)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="kw">library</span>(ANTsR)</a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="kw">library</span>(extrantsr)</a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="kw">library</span>(neurobase)</a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="kw">library</span>(oro.nifti)</a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="kw">library</span>(fslr)</a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="kw">library</span>(scales)</a></code></pre></div>
<p><code>ANTsRCore</code>, <code>ANTsR</code> and <code>extrantsr</code> are going to be used for input/output tasks as well as for different processes. <code>fslr</code> will be used to segment the image into tissue types.</p>
<p><code>neurobase</code> and <code>oro.nifti</code> are mainly used for input/output and to plot nifti objects.</p>
<p>The <code>tidyverse</code> simplifies many of the processes in the functions.</p>
<p>The <code>scales</code> library is used just for assigning colors in an automatic way in graphics.</p>
</div>
<div id="other-resources" class="section level2">
<h2 class="hasAnchor">
<a href="#other-resources" class="anchor"></a>Other Resources</h2>
<p>At the beginning of the workflow, we need a template image in order to reorient our input into MNI space. We’ll use the “MNI152_T1_1mm” template file available, for example, from FSL companion data.</p>
<p>On the other hand, we intend to use the MALF (Multi-Atlas Label Fusion) algorithm, present in the <code>ANTsR</code> package, in two cases:</p>
<ul>
<li>To perform brain extraction</li>
<li>To obtain the anatomical parcellation of the subcortical nuclei.</li>
</ul>
<p>Thus, we’ll need sample data of images manually labelled for both of these tasks.</p>
<p>Brain MRIs with its corresponding skull-stripped versions are available for free at the <a href="http://preprocessed-connectomes-project.org/NFB_skullstripped/">Neurofeedback Skull-stripped (NFBS) repository</a>.</p>
<p>On the other hand, we’ll use data from <a href="https://mindboggle.info/data.html">Mindboggle101</a> consisting in brain images with corresponding manual labellings.</p>
</div>
</div>
<div id="volumetry" class="section level1">
<h1 class="hasAnchor">
<a href="#volumetry" class="anchor"></a>Volumetry</h1>
<p>The volumetry workflow will be a <code>NIflow</code> object. To create such object, one needs to provide a <em>name</em>, a <em>work_dir</em> where to store temporary results, and the name of the <em>inputs</em> needed to execute the workflow. In this case, our pipeline will only need a T1 image to obtain the results.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">volumetry_flow &lt;-<span class="st"> </span>NIflow<span class="op">$</span><span class="kw">new</span>(<span class="dt">name =</span> <span class="st">"volumetry"</span>,</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">                             <span class="dt">work_dir =</span> <span class="st">"~/flow/volumetry"</span>,</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">                             <span class="dt">inputs =</span> <span class="st">"T1"</span>)</a></code></pre></div>
<p>In the next sections, we’ll provide the complete structure of the workflow, just by using skeletons of the functions needed.</p>
<div id="register-to-template-space" class="section level2">
<h2 class="hasAnchor">
<a href="#register-to-template-space" class="anchor"></a>Register to Template Space</h2>
<p>In this task, we’ll use a function (from the <code>ANTsR</code> package) to compute the (affine) transformation from our input image to a standard template. Once we have the transformation given by the <code>register_to_template</code> function, we have to explicitly compute the transformed image, the affine matrix and the scale parameter (the determinant of the affine matrix).</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># - register to a template (MNI152 in case of structural imaging)</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="co"># Returns the transformation, as declared in the ANTsRCore package</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3">register_to_template &lt;-<span class="st"> </span><span class="cf">function</span>(image, template) {</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">  <span class="co">#...</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5">}</a>
<a class="sourceLine" id="cb4-6" data-line-number="6"></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="co"># Returns the image reoriented in the template space</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8">get_img_in_template &lt;-<span class="st"> </span><span class="cf">function</span>(tx) {</a>
<a class="sourceLine" id="cb4-9" data-line-number="9">  <span class="co">#...</span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10">}</a>
<a class="sourceLine" id="cb4-11" data-line-number="11"></a>
<a class="sourceLine" id="cb4-12" data-line-number="12"><span class="co"># Returns the affine transformation</span></a>
<a class="sourceLine" id="cb4-13" data-line-number="13">get_tx_to_template &lt;-<span class="st"> </span><span class="cf">function</span>(tx) {</a>
<a class="sourceLine" id="cb4-14" data-line-number="14">  <span class="co">#...</span></a>
<a class="sourceLine" id="cb4-15" data-line-number="15">}</a>
<a class="sourceLine" id="cb4-16" data-line-number="16"></a>
<a class="sourceLine" id="cb4-17" data-line-number="17"><span class="co"># Returns the scale parameter as the determinant of the affine transformation</span></a>
<a class="sourceLine" id="cb4-18" data-line-number="18">get_scale_parameter &lt;-<span class="st"> </span><span class="cf">function</span>(M) {</a>
<a class="sourceLine" id="cb4-19" data-line-number="19">  <span class="co">#...</span></a>
<a class="sourceLine" id="cb4-20" data-line-number="20">}</a></code></pre></div>
<p>The template that we’ll use is located in (change to your local installation, if needed):</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">template &lt;-<span class="st"> </span><span class="kw">file.path</span>(<span class="st">"."</span>, <span class="st">"resources"</span>,</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">                      <span class="st">"volumetry"</span>, <span class="st">"MNI152_T1_1mm.nii.gz"</span>)</a></code></pre></div>
<p>We add the previous functions as steps in our workflow, stating clearly the inputs needed in each step, as well as the output provided in each one. Note that the <code>add</code> function allows for extra arguments (in particular, argument <code>template</code> to function <code>register_to_template</code>) for the functions used in the step. In this case, <code>T1_MNI</code> stands for T1 image in MNI space.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">volumetry_flow<span class="op">$</span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> register_to_template,</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">                   <span class="dt">inputs =</span> <span class="st">"T1"</span>,</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">                   <span class="dt">output =</span> <span class="st">"transformation"</span>,</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">                   <span class="dt">template =</span> template)</a>
<a class="sourceLine" id="cb6-5" data-line-number="5"></a>
<a class="sourceLine" id="cb6-6" data-line-number="6">volumetry_flow<span class="op">$</span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> get_img_in_template,</a>
<a class="sourceLine" id="cb6-7" data-line-number="7">                   <span class="dt">inputs =</span> <span class="st">"transformation"</span>,</a>
<a class="sourceLine" id="cb6-8" data-line-number="8">                   <span class="dt">output =</span> <span class="st">"T1_MNI"</span>)</a>
<a class="sourceLine" id="cb6-9" data-line-number="9"></a>
<a class="sourceLine" id="cb6-10" data-line-number="10">volumetry_flow<span class="op">$</span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> get_tx_to_template,</a>
<a class="sourceLine" id="cb6-11" data-line-number="11">                   <span class="dt">inputs =</span> <span class="st">"transformation"</span>,</a>
<a class="sourceLine" id="cb6-12" data-line-number="12">                   <span class="dt">output =</span> <span class="st">"affine_transform"</span>)</a>
<a class="sourceLine" id="cb6-13" data-line-number="13"></a>
<a class="sourceLine" id="cb6-14" data-line-number="14">volumetry_flow<span class="op">$</span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> get_scale_parameter,</a>
<a class="sourceLine" id="cb6-15" data-line-number="15">                   <span class="dt">inputs =</span> <span class="st">"affine_transform"</span>,</a>
<a class="sourceLine" id="cb6-16" data-line-number="16">                   <span class="dt">output =</span> <span class="st">"scale_parameter"</span>)</a></code></pre></div>
<p>Alternatively, one could simply use the <code>%&gt;%</code> (pipe) operator to concatenate the operations, as follows:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">volumetry_flow  <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> register_to_template,</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">      <span class="dt">inputs =</span> <span class="st">"T1"</span>,</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">      <span class="dt">output =</span> <span class="st">"transformation"</span>,</a>
<a class="sourceLine" id="cb7-5" data-line-number="5">      <span class="dt">template =</span> template) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="st">  </span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> get_img_in_template,</a>
<a class="sourceLine" id="cb7-7" data-line-number="7">      <span class="dt">inputs =</span> <span class="st">"transformation"</span>,</a>
<a class="sourceLine" id="cb7-8" data-line-number="8">      <span class="dt">output =</span> <span class="st">"T1_MNI"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-9" data-line-number="9"><span class="st">  </span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> get_tx_to_template,</a>
<a class="sourceLine" id="cb7-10" data-line-number="10">      <span class="dt">inputs =</span> <span class="st">"transformation"</span>,</a>
<a class="sourceLine" id="cb7-11" data-line-number="11">      <span class="dt">output =</span> <span class="st">"affine_transform"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-12" data-line-number="12"><span class="st">  </span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> get_scale_parameter,</a>
<a class="sourceLine" id="cb7-13" data-line-number="13">      <span class="dt">inputs =</span> <span class="st">"affine_transform"</span>,</a>
<a class="sourceLine" id="cb7-14" data-line-number="14">      <span class="dt">output =</span> <span class="st">"scale_parameter"</span>)</a></code></pre></div>
<p>With this little effort, we have built the following flow:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">volumetry_flow<span class="op">$</span><span class="kw"><a href="../reference/plot.html">plot</a></span>()</a></code></pre></div>
<p><img src="volumetry_files/figure-html/unnamed-chunk-4-1.png" width="480"></p>
</div>
<div id="bias-field-correction" class="section level2">
<h2 class="hasAnchor">
<a href="#bias-field-correction" class="anchor"></a>Bias Field Correction</h2>
<p>Next step is correction of the intensity inhomogeneities, using <code>ANTsR</code> package.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="co"># - bias field correction, just a simple wrapper around</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="co"># n4BiasFieldCorrection</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3">bfc &lt;-<span class="st"> </span><span class="cf">function</span>(img) {</a>
<a class="sourceLine" id="cb9-4" data-line-number="4">  <span class="co">#...</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5">}</a></code></pre></div>
<p>We add this step, which will be applied on the <code>T1_MNI</code> step before, and will provide with an image named <code>T1_bfc</code>:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">volumetry_flow<span class="op">$</span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> bfc,</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">                   <span class="dt">inputs =</span> <span class="st">"T1_MNI"</span>,</a>
<a class="sourceLine" id="cb10-3" data-line-number="3">                   <span class="dt">output =</span> <span class="st">"T1_bfc"</span>)</a></code></pre></div>
<p>Flow up to now is as follows:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">volumetry_flow<span class="op">$</span><span class="kw"><a href="../reference/plot.html">plot</a></span>()</a></code></pre></div>
<p><img src="volumetry_files/figure-html/unnamed-chunk-5-1.png" width="480"></p>
</div>
<div id="brain-extraction" class="section level2">
<h2 class="hasAnchor">
<a href="#brain-extraction" class="anchor"></a>Brain Extraction</h2>
<p>The function to perform brain extraction uses the MALF technique implemented in the <code>ANTsR</code> package. Thus, we need to provide template images and template label images to this function.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="co"># - brain extraction</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="co"># Uses MALF technique with a "brain extraction" dataset</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="co"># Returns the brain mask</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4">make_brain_extraction &lt;-<span class="st"> </span><span class="cf">function</span>(image, </a>
<a class="sourceLine" id="cb12-5" data-line-number="5">                                  template_images, </a>
<a class="sourceLine" id="cb12-6" data-line-number="6">                                  template_structs) {</a>
<a class="sourceLine" id="cb12-7" data-line-number="7">  <span class="co">#...</span></a>
<a class="sourceLine" id="cb12-8" data-line-number="8">}</a></code></pre></div>
<p>Now, we make a list of the template images and labels that we have (see <em>Requirements</em> section) and provide it as extra arguments in the flow:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">template_folder &lt;-<span class="st"> </span><span class="kw">file.path</span>(<span class="st">"."</span>, <span class="st">"resources"</span>, <span class="st">"volumetry"</span>, <span class="st">"bet"</span>)</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">template_images_bet &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="dt">path =</span> <span class="kw">file.path</span>(template_folder,</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">                                               <span class="st">"images"</span>),</a>
<a class="sourceLine" id="cb13-4" data-line-number="4">                              <span class="dt">pattern =</span> <span class="st">".nii.gz"</span>,</a>
<a class="sourceLine" id="cb13-5" data-line-number="5">                              <span class="dt">full.names =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb13-6" data-line-number="6">template_structs_bet &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="dt">path =</span> <span class="kw">file.path</span>(template_folder,</a>
<a class="sourceLine" id="cb13-7" data-line-number="7">                                               <span class="st">"masks"</span>),</a>
<a class="sourceLine" id="cb13-8" data-line-number="8">                              <span class="dt">pattern =</span> <span class="st">".nii.gz"</span>,</a>
<a class="sourceLine" id="cb13-9" data-line-number="9">                              <span class="dt">full.names =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">volumetry_flow<span class="op">$</span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> make_brain_extraction,</a>
<a class="sourceLine" id="cb14-2" data-line-number="2">                   <span class="dt">inputs =</span> <span class="st">"T1_bfc"</span>,</a>
<a class="sourceLine" id="cb14-3" data-line-number="3">                   <span class="dt">output =</span> <span class="st">"brain_mask"</span>,</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">                   <span class="dt">template_images =</span> template_images_bet,</a>
<a class="sourceLine" id="cb14-5" data-line-number="5">                   <span class="dt">template_structs =</span> template_structs_bet)</a>
<a class="sourceLine" id="cb14-6" data-line-number="6"></a>
<a class="sourceLine" id="cb14-7" data-line-number="7">volumetry_flow<span class="op">$</span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> <span class="cf">function</span>(A, B) {A <span class="op">*</span><span class="st"> </span>B},</a>
<a class="sourceLine" id="cb14-8" data-line-number="8">                   <span class="dt">inputs =</span> <span class="kw">c</span>(<span class="st">"T1_bfc"</span>, <span class="st">"brain_mask"</span>),</a>
<a class="sourceLine" id="cb14-9" data-line-number="9">                   <span class="dt">output =</span> <span class="st">"betted"</span>)</a></code></pre></div>
<p>This last function computes the brain-extracted image. Since the <code>brain_mask</code> consists of 0s and 1s, multiplying it by the bias-field-corrected image will produce the skull-stripped (betted) image.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">volumetry_flow<span class="op">$</span><span class="kw"><a href="../reference/plot.html">plot</a></span>()</a></code></pre></div>
<p><img src="volumetry_files/figure-html/unnamed-chunk-6-1.png" width="480"></p>
</div>
<div id="segmentation" class="section level2">
<h2 class="hasAnchor">
<a href="#segmentation" class="anchor"></a>Segmentation</h2>
<p>The segmentation step will be performed by FSL by means of the <code>fslr</code> package. It needes a brain extracted image as input. Since we have it computed in the previous step, we’ll use as the input for this function.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="co"># - segmentation (GM, WM an CSF)</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="co"># Uses FSL's FAST tool to find a segmentation into GM, WM and CSF</span></a>
<a class="sourceLine" id="cb16-3" data-line-number="3"><span class="co"># Returns the segmentation as a labelled image with labels 0 (background),</span></a>
<a class="sourceLine" id="cb16-4" data-line-number="4"><span class="co"># 1 (CSF), 2 (GM) and 3 (WM)</span></a>
<a class="sourceLine" id="cb16-5" data-line-number="5">get_segmentation &lt;-<span class="st"> </span><span class="cf">function</span>(img, <span class="dt">mask =</span> <span class="ot">NULL</span>) {</a>
<a class="sourceLine" id="cb16-6" data-line-number="6">  <span class="co">#...</span></a>
<a class="sourceLine" id="cb16-7" data-line-number="7">}</a></code></pre></div>
<p>Thus, the flow in this step is updated simply by doing:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">volumetry_flow<span class="op">$</span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> get_segmentation,</a>
<a class="sourceLine" id="cb17-2" data-line-number="2">                   <span class="dt">inputs =</span> <span class="st">"betted"</span>,</a>
<a class="sourceLine" id="cb17-3" data-line-number="3">                   <span class="dt">output =</span> <span class="st">"segmentation"</span>)</a></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">volumetry_flow<span class="op">$</span><span class="kw"><a href="../reference/plot.html">plot</a></span>()</a></code></pre></div>
<p><img src="volumetry_files/figure-html/unnamed-chunk-7-1.png" width="480"></p>
</div>
<div id="anatomical-parcellation" class="section level2">
<h2 class="hasAnchor">
<a href="#anatomical-parcellation" class="anchor"></a>Anatomical Parcellation</h2>
<p>Another key step of the workflow is the anatomical labelling, also based on the MALF technique. We’ll need a skull-stripped image and template images and labels.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="co"># - parcellation</span></a>
<a class="sourceLine" id="cb19-2" data-line-number="2"><span class="co"># Uses MALF technique with a previously labelled dataset</span></a>
<a class="sourceLine" id="cb19-3" data-line-number="3">make_subcortical_parcellation &lt;-<span class="st"> </span><span class="cf">function</span>(image,</a>
<a class="sourceLine" id="cb19-4" data-line-number="4">                                          <span class="dt">mask =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb19-5" data-line-number="5">                                          template_images,</a>
<a class="sourceLine" id="cb19-6" data-line-number="6">                                          template_structs) {</a>
<a class="sourceLine" id="cb19-7" data-line-number="7">  <span class="co">#...</span></a>
<a class="sourceLine" id="cb19-8" data-line-number="8">}</a>
<a class="sourceLine" id="cb19-9" data-line-number="9"></a>
<a class="sourceLine" id="cb19-10" data-line-number="10"><span class="co"># Removes CSF voxels from the parcellation</span></a>
<a class="sourceLine" id="cb19-11" data-line-number="11">refine_parcellation &lt;-<span class="st"> </span><span class="cf">function</span>(parcellation, segmentation) {</a>
<a class="sourceLine" id="cb19-12" data-line-number="12">  <span class="co">#...</span></a>
<a class="sourceLine" id="cb19-13" data-line-number="13">}</a></code></pre></div>
<p>We also use the segmentation information to refine the parcellation, just by removing CSF voxels form the subcortical nuclei delimited in the previous function.</p>
<p>We list all the template images and labels to be used in this step:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">template_folder &lt;-<span class="st"> </span><span class="kw">file.path</span>(<span class="st">"."</span>, <span class="st">"resources"</span>, <span class="st">"volumetry"</span>, <span class="st">"parcellation"</span>)</a>
<a class="sourceLine" id="cb20-2" data-line-number="2">template_images_parc &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="dt">path =</span> <span class="kw">file.path</span>(template_folder,</a>
<a class="sourceLine" id="cb20-3" data-line-number="3">                                               <span class="st">"images"</span>),</a>
<a class="sourceLine" id="cb20-4" data-line-number="4">                              <span class="dt">pattern =</span> <span class="st">".nii.gz"</span>,</a>
<a class="sourceLine" id="cb20-5" data-line-number="5">                              <span class="dt">full.names =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb20-6" data-line-number="6">template_structs_parc &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="dt">path =</span> <span class="kw">file.path</span>(template_folder,</a>
<a class="sourceLine" id="cb20-7" data-line-number="7">                                               <span class="st">"masks"</span>),</a>
<a class="sourceLine" id="cb20-8" data-line-number="8">                              <span class="dt">pattern =</span> <span class="st">".nii.gz"</span>,</a>
<a class="sourceLine" id="cb20-9" data-line-number="9">                              <span class="dt">full.names =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p>And use them as extra arguments for the <code>make_subcortical_parcellation</code> function in this step:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">volumetry_flow<span class="op">$</span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> make_subcortical_parcellation,</a>
<a class="sourceLine" id="cb21-2" data-line-number="2">                   <span class="dt">inputs =</span> <span class="st">"betted"</span>,</a>
<a class="sourceLine" id="cb21-3" data-line-number="3">                   <span class="dt">output =</span> <span class="st">"parcellation_basic"</span>,</a>
<a class="sourceLine" id="cb21-4" data-line-number="4">                   <span class="dt">template_images =</span> template_images_parc,</a>
<a class="sourceLine" id="cb21-5" data-line-number="5">                   <span class="dt">template_structs =</span> template_structs_parc)</a>
<a class="sourceLine" id="cb21-6" data-line-number="6"></a>
<a class="sourceLine" id="cb21-7" data-line-number="7">volumetry_flow<span class="op">$</span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> refine_parcellation,</a>
<a class="sourceLine" id="cb21-8" data-line-number="8">                   <span class="dt">inputs =</span> <span class="kw">c</span>(<span class="st">"parcellation_basic"</span>, <span class="st">"segmentation"</span>),</a>
<a class="sourceLine" id="cb21-9" data-line-number="9">                   <span class="dt">output =</span> <span class="st">"parcellation"</span>)</a></code></pre></div>
<p>Without the quantification part, this is the flow we are building:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1">volumetry_flow<span class="op">$</span><span class="kw"><a href="../reference/plot.html">plot</a></span>()</a></code></pre></div>
<p><img src="volumetry_files/figure-html/unnamed-chunk-8-1.png" width="480"></p>
</div>
<div id="quantification" class="section level2">
<h2 class="hasAnchor">
<a href="#quantification" class="anchor"></a>Quantification</h2>
<p>We define a function that computes the number of voxels for each region of interest labelled in an image.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1">count_by_ROI &lt;-<span class="st"> </span><span class="cf">function</span>(img) {</a>
<a class="sourceLine" id="cb23-2" data-line-number="2">  <span class="co">#...</span></a>
<a class="sourceLine" id="cb23-3" data-line-number="3">}</a></code></pre></div>
<p>We use repeatedly this function to count voxels inside the brain, inside each type of tissue, and in each of the subcortical nuclei. These are estimations of volumes in MNI space (where the volume of a single voxel is 1mm^3). To compute the actual real volume, we must multiplicate this <em>MNI volume</em> by the scale parameter derived from the affine transformation in the first step.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1">volumetry_flow<span class="op">$</span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> count_by_ROI,</a>
<a class="sourceLine" id="cb24-2" data-line-number="2">                   <span class="dt">inputs =</span> <span class="st">"brain_mask"</span>,</a>
<a class="sourceLine" id="cb24-3" data-line-number="3">                   <span class="dt">output =</span> <span class="st">"brain_volume_mni"</span>)</a>
<a class="sourceLine" id="cb24-4" data-line-number="4"></a>
<a class="sourceLine" id="cb24-5" data-line-number="5">volumetry_flow<span class="op">$</span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> <span class="cf">function</span>(A, B) {A <span class="op">*</span><span class="st"> </span>B},</a>
<a class="sourceLine" id="cb24-6" data-line-number="6">                   <span class="dt">inputs =</span> <span class="kw">c</span>(<span class="st">"brain_volume_mni"</span>, <span class="st">"scale_parameter"</span>),</a>
<a class="sourceLine" id="cb24-7" data-line-number="7">                   <span class="dt">output =</span> <span class="st">"brain_volume"</span>)</a>
<a class="sourceLine" id="cb24-8" data-line-number="8"></a>
<a class="sourceLine" id="cb24-9" data-line-number="9">volumetry_flow<span class="op">$</span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> count_by_ROI,</a>
<a class="sourceLine" id="cb24-10" data-line-number="10">                   <span class="dt">inputs =</span> <span class="st">"segmentation"</span>,</a>
<a class="sourceLine" id="cb24-11" data-line-number="11">                   <span class="dt">output =</span> <span class="st">"basic_volumetry_mni"</span>)</a>
<a class="sourceLine" id="cb24-12" data-line-number="12"></a>
<a class="sourceLine" id="cb24-13" data-line-number="13">volumetry_flow<span class="op">$</span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> <span class="cf">function</span>(A, B) {A <span class="op">*</span><span class="st"> </span>B},</a>
<a class="sourceLine" id="cb24-14" data-line-number="14">                   <span class="dt">inputs =</span> <span class="kw">c</span>(<span class="st">"basic_volumetry_mni"</span>, <span class="st">"scale_parameter"</span>),</a>
<a class="sourceLine" id="cb24-15" data-line-number="15">                   <span class="dt">output =</span> <span class="st">"basic_volumetry"</span>)</a>
<a class="sourceLine" id="cb24-16" data-line-number="16"></a>
<a class="sourceLine" id="cb24-17" data-line-number="17">volumetry_flow<span class="op">$</span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> count_by_ROI,</a>
<a class="sourceLine" id="cb24-18" data-line-number="18">                   <span class="dt">inputs =</span> <span class="st">"parcellation"</span>,</a>
<a class="sourceLine" id="cb24-19" data-line-number="19">                   <span class="dt">output =</span> <span class="st">"final_volumetry_mni"</span>)</a>
<a class="sourceLine" id="cb24-20" data-line-number="20"></a>
<a class="sourceLine" id="cb24-21" data-line-number="21">volumetry_flow<span class="op">$</span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> <span class="cf">function</span>(A, B) {A <span class="op">*</span><span class="st"> </span>B},</a>
<a class="sourceLine" id="cb24-22" data-line-number="22">                   <span class="dt">inputs =</span> <span class="kw">c</span>(<span class="st">"final_volumetry_mni"</span>, <span class="st">"scale_parameter"</span>),</a>
<a class="sourceLine" id="cb24-23" data-line-number="23">                   <span class="dt">output =</span> <span class="st">"final_volumetry"</span>)</a></code></pre></div>
</div>
</div>
<div id="final-flow" class="section level1">
<h1 class="hasAnchor">
<a href="#final-flow" class="anchor"></a>Final Flow</h1>
<p>With these last additions, the flow is as follows:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1">volumetry_flow<span class="op">$</span><span class="kw"><a href="../reference/plot.html">plot</a></span>()</a></code></pre></div>
<p><img src="volumetry_files/figure-html/flow_plot-1.png" width="672"></p>
<p>We can also obtain a brief summary of the flow by typing:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1"><span class="kw">summary</span>(volumetry_flow)</a>
<a class="sourceLine" id="cb26-2" data-line-number="2"><span class="co">#&gt; NIflow object with:</span></a>
<a class="sourceLine" id="cb26-3" data-line-number="3"><span class="co">#&gt;   name: volumetry </span></a>
<a class="sourceLine" id="cb26-4" data-line-number="4"><span class="co">#&gt;   inputs: T1 </span></a>
<a class="sourceLine" id="cb26-5" data-line-number="5"><span class="co">#&gt;   outputs: transformation, T1_MNI, affine_transform, scale_parameter, T1_bfc, brain_mask, betted, segmentation, parcellation_basic, parcellation, brain_volume_mni, brain_volume, basic_volumetry_mni, basic_volumetry, final_volumetry_mni, final_volumetry </span></a>
<a class="sourceLine" id="cb26-6" data-line-number="6"><span class="co">#&gt; Currently using 2.06 MB of memory.</span></a>
<a class="sourceLine" id="cb26-7" data-line-number="7"><span class="co">#&gt; Summary of processes:</span></a>
<a class="sourceLine" id="cb26-8" data-line-number="8"><span class="co">#&gt;   transformation needs T1 as inputs.</span></a>
<a class="sourceLine" id="cb26-9" data-line-number="9"><span class="co">#&gt;   T1_MNI needs transformation as inputs.</span></a>
<a class="sourceLine" id="cb26-10" data-line-number="10"><span class="co">#&gt;   affine_transform needs transformation as inputs.</span></a>
<a class="sourceLine" id="cb26-11" data-line-number="11"><span class="co">#&gt;   scale_parameter needs affine_transform as inputs.</span></a>
<a class="sourceLine" id="cb26-12" data-line-number="12"><span class="co">#&gt;   T1_bfc needs T1_MNI as inputs.</span></a>
<a class="sourceLine" id="cb26-13" data-line-number="13"><span class="co">#&gt;   brain_mask needs T1_bfc as inputs.</span></a>
<a class="sourceLine" id="cb26-14" data-line-number="14"><span class="co">#&gt;   betted needs T1_bfc, brain_mask as inputs.</span></a>
<a class="sourceLine" id="cb26-15" data-line-number="15"><span class="co">#&gt;   segmentation needs betted as inputs.</span></a>
<a class="sourceLine" id="cb26-16" data-line-number="16"><span class="co">#&gt;   parcellation_basic needs betted as inputs.</span></a>
<a class="sourceLine" id="cb26-17" data-line-number="17"><span class="co">#&gt;   parcellation needs parcellation_basic, segmentation as inputs.</span></a>
<a class="sourceLine" id="cb26-18" data-line-number="18"><span class="co">#&gt;   brain_volume_mni needs brain_mask as inputs.</span></a>
<a class="sourceLine" id="cb26-19" data-line-number="19"><span class="co">#&gt;   brain_volume needs brain_volume_mni, scale_parameter as inputs.</span></a>
<a class="sourceLine" id="cb26-20" data-line-number="20"><span class="co">#&gt;   basic_volumetry_mni needs segmentation as inputs.</span></a>
<a class="sourceLine" id="cb26-21" data-line-number="21"><span class="co">#&gt;   basic_volumetry needs basic_volumetry_mni, scale_parameter as inputs.</span></a>
<a class="sourceLine" id="cb26-22" data-line-number="22"><span class="co">#&gt;   final_volumetry_mni needs parcellation as inputs.</span></a>
<a class="sourceLine" id="cb26-23" data-line-number="23"><span class="co">#&gt;   final_volumetry needs final_volumetry_mni, scale_parameter as inputs.</span></a></code></pre></div>
</div>
<div id="example" class="section level1">
<h1 class="hasAnchor">
<a href="#example" class="anchor"></a>Example</h1>
<p>To illustrate how this workflow can be used, let us suppose that we have all the functions mentioned before already implemented (an example implementation is given in the Annex), and build the workflow as in the previous steps. We’ll apply this flow to compute the brain mask, the segmentation, the parcellation and the volumes of brain, tissues and subcortical nuclei.</p>
<div id="code" class="section level2">
<h2 class="hasAnchor">
<a href="#code" class="anchor"></a>Code</h2>
<p>Using a T1 nifti file as input, we execute:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1">my_t1 &lt;-<span class="st"> </span><span class="kw">file.path</span>(<span class="st">"."</span>, <span class="st">"resources"</span>,</a>
<a class="sourceLine" id="cb27-2" data-line-number="2">                   <span class="st">"volumetry"</span>, <span class="st">"input"</span>,</a>
<a class="sourceLine" id="cb27-3" data-line-number="3">                   <span class="st">"t1.nii.gz"</span>)</a>
<a class="sourceLine" id="cb27-4" data-line-number="4"></a>
<a class="sourceLine" id="cb27-5" data-line-number="5">res &lt;-<span class="st"> </span>volumetry_flow<span class="op">$</span><span class="kw">compute</span>(<span class="dt">what =</span> <span class="kw">c</span>(<span class="st">"T1_bfc"</span>,</a>
<a class="sourceLine" id="cb27-6" data-line-number="6">                                       <span class="st">"brain_mask"</span>,</a>
<a class="sourceLine" id="cb27-7" data-line-number="7">                                       <span class="st">"segmentation"</span>,</a>
<a class="sourceLine" id="cb27-8" data-line-number="8">                                       <span class="st">"parcellation"</span>,</a>
<a class="sourceLine" id="cb27-9" data-line-number="9">                                       <span class="st">"brain_volume"</span>,</a>
<a class="sourceLine" id="cb27-10" data-line-number="10">                                       <span class="st">"basic_volumetry"</span>,</a>
<a class="sourceLine" id="cb27-11" data-line-number="11">                                       <span class="st">"final_volumetry"</span>),</a>
<a class="sourceLine" id="cb27-12" data-line-number="12">                              <span class="dt">from =</span> <span class="kw">list</span>(<span class="dt">T1 =</span> my_t1))</a></code></pre></div>
</div>
<div id="results" class="section level2">
<h2 class="hasAnchor">
<a href="#results" class="anchor"></a>Results</h2>
<p>Let us inspect the different results:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1"><span class="kw">names</span>(res<span class="op">$</span>brain_volume) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"brain_volume"</span>)</a>
<a class="sourceLine" id="cb28-2" data-line-number="2">res<span class="op">$</span>brain_volume</a></code></pre></div>
<pre><code>#&gt; brain_volume 
#&gt;      1664779</code></pre>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1"><span class="kw">names</span>(res<span class="op">$</span>basic_volumetry) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"CSF"</span>, <span class="st">"GM"</span>, <span class="st">"WM"</span>)</a>
<a class="sourceLine" id="cb30-2" data-line-number="2">res<span class="op">$</span>basic_volumetry</a></code></pre></div>
<pre><code>#&gt;      CSF       GM       WM 
#&gt; 390287.2 651682.9 622726.1</code></pre>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" data-line-number="1"><span class="kw">names</span>(res<span class="op">$</span>final_volumetry) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"left thalamus proper"</span>,</a>
<a class="sourceLine" id="cb32-2" data-line-number="2">                                <span class="st">"left caudate"</span>, <span class="st">"left putamen"</span>, </a>
<a class="sourceLine" id="cb32-3" data-line-number="3">                                <span class="st">"left pallidum"</span>, <span class="st">"left hippocampus"</span>, </a>
<a class="sourceLine" id="cb32-4" data-line-number="4">                                <span class="st">"left amygdala"</span>, <span class="st">"right thalamus proper"</span>,</a>
<a class="sourceLine" id="cb32-5" data-line-number="5">                                <span class="st">"right caudate"</span>, <span class="st">"right putamen"</span>, </a>
<a class="sourceLine" id="cb32-6" data-line-number="6">                                <span class="st">"right pallidum"</span>, <span class="st">"right hippocampus"</span>, </a>
<a class="sourceLine" id="cb32-7" data-line-number="7">                                <span class="st">"right amygdala"</span>)</a>
<a class="sourceLine" id="cb32-8" data-line-number="8"></a>
<a class="sourceLine" id="cb32-9" data-line-number="9">res<span class="op">$</span>final_volumetry</a></code></pre></div>
<pre><code>#&gt;  left thalamus proper          left caudate          left putamen 
#&gt;             10435.434              4352.073              6457.049 
#&gt;         left pallidum      left hippocampus         left amygdala 
#&gt;              2098.019              4952.359              1231.381 
#&gt; right thalamus proper         right caudate         right putamen 
#&gt;             10135.291              4704.890              6403.381 
#&gt;        right pallidum     right hippocampus        right amygdala 
#&gt;              2193.429              5508.915              1256.227</code></pre>
</div>
<div id="images" class="section level2">
<h2 class="hasAnchor">
<a href="#images" class="anchor"></a>Images</h2>
<p>Also, using this function (a simple extension of <code>neurobase</code>’s <code>ortho2</code> function), we can inspect the volumes provided as results of the workflow execution:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" data-line-number="1"><span class="co"># Plot an anatomical image with an overlay</span></a>
<a class="sourceLine" id="cb34-2" data-line-number="2">plot_overlay &lt;-<span class="st"> </span><span class="cf">function</span>(image, overlay, <span class="dt">text =</span> <span class="st">""</span>) {</a>
<a class="sourceLine" id="cb34-3" data-line-number="3">  </a>
<a class="sourceLine" id="cb34-4" data-line-number="4">  label_ids &lt;-<span class="st"> </span>overlay <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.vector</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unique</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sort</span>()</a>
<a class="sourceLine" id="cb34-5" data-line-number="5">  label_ids &lt;-<span class="st"> </span>label_ids[<span class="op">-</span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb34-6" data-line-number="6">  overlay &lt;-<span class="st"> </span><span class="kw">remap_labels</span>(<span class="dt">img =</span> overlay)</a>
<a class="sourceLine" id="cb34-7" data-line-number="7">  </a>
<a class="sourceLine" id="cb34-8" data-line-number="8">  num_classes &lt;-<span class="st"> </span><span class="kw">length</span>(label_ids) <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb34-9" data-line-number="9">  col.y &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/scales/topics/alpha">alpha</a></span>(<span class="dt">colour =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/scales/topics/hue_pal">hue_pal</a></span>()(num_classes), <span class="dt">alpha =</span> <span class="fl">0.45</span>)</a>
<a class="sourceLine" id="cb34-10" data-line-number="10">  </a>
<a class="sourceLine" id="cb34-11" data-line-number="11">  <span class="cf">if</span> (num_classes <span class="op">==</span><span class="st"> </span><span class="dv">4</span>)</a>
<a class="sourceLine" id="cb34-12" data-line-number="12">    col.y &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/scales/topics/alpha">alpha</a></span>(<span class="dt">colour =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/scales/topics/viridis_pal">viridis_pal</a></span>()(num_classes), <span class="dt">alpha =</span> <span class="fl">0.3</span>)</a>
<a class="sourceLine" id="cb34-13" data-line-number="13">  </a>
<a class="sourceLine" id="cb34-14" data-line-number="14">  <span class="kw"><a href="http://www.rdocumentation.org/packages/neurobase/topics/ortho2">ortho2</a></span>(<span class="dt">x =</span> image, <span class="dt">y =</span> overlay, <span class="dt">col.y =</span> col.y, <span class="dt">text =</span> text)</a>
<a class="sourceLine" id="cb34-15" data-line-number="15">  </a>
<a class="sourceLine" id="cb34-16" data-line-number="16">}</a></code></pre></div>
<p>The brain mask:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1"><span class="kw">plot_overlay</span>(<span class="dt">image =</span> res<span class="op">$</span>T1_bfc,</a>
<a class="sourceLine" id="cb35-2" data-line-number="2">             <span class="dt">overlay =</span> res<span class="op">$</span>brain_mask,</a>
<a class="sourceLine" id="cb35-3" data-line-number="3">             <span class="dt">text =</span> <span class="st">"Brain Mask"</span>)</a></code></pre></div>
<p><img src="img/vol_brain_mask.png" width="640"></p>
<p>The segmented image:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" data-line-number="1"><span class="kw">plot_overlay</span>(<span class="dt">image =</span> res<span class="op">$</span>T1_bfc,</a>
<a class="sourceLine" id="cb36-2" data-line-number="2">             <span class="dt">overlay =</span> res<span class="op">$</span>segmentation,</a>
<a class="sourceLine" id="cb36-3" data-line-number="3">             <span class="dt">text =</span> <span class="st">"Segmentation"</span>)</a></code></pre></div>
<p><img src="img/vol_segmentation.png" width="640"></p>
<p>The anatomical parcellation:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1"><span class="kw">plot_overlay</span>(<span class="dt">image =</span> res<span class="op">$</span>T1_bfc,</a>
<a class="sourceLine" id="cb37-2" data-line-number="2">             <span class="dt">overlay =</span> res<span class="op">$</span>parcellation,</a>
<a class="sourceLine" id="cb37-3" data-line-number="3">             <span class="dt">text =</span> <span class="st">"Parcellation"</span>)</a></code></pre></div>
<p><img src="img/vol.parcellation.png" width="640"></p>
</div>
<div id="full-flow-log" class="section level2">
<h2 class="hasAnchor">
<a href="#full-flow-log" class="anchor"></a>Full Flow Log</h2>
<p>The <code>NIflow</code> object stores internally a log of all the processes that it goes through and the memory used to store its internal results:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb38-1" data-line-number="1">volumetry_flow<span class="op">$</span><span class="kw">print_log</span>()</a></code></pre></div>
<pre><code>#&gt; (2019-04-28 23:55:14) [DEBUG] Adding process with inputs: T1 and output(s): transformation
#&gt; (2019-04-28 23:55:15) [DEBUG] Adding process with inputs: transformation and output(s): T1_MNI
#&gt; (2019-04-28 23:55:15) [DEBUG] Adding process with inputs: transformation and output(s): affine_transform
#&gt; (2019-04-28 23:55:15) [DEBUG] Adding process with inputs: affine_transform and output(s): scale_parameter
#&gt; (2019-04-28 23:55:15) [DEBUG] Adding process with inputs: T1_MNI and output(s): T1_bfc
#&gt; (2019-04-28 23:55:15) [DEBUG] Adding process with inputs: T1_bfc and output(s): brain_mask
#&gt; (2019-04-28 23:55:15) [DEBUG] Adding process with inputs: T1_bfc, brain_mask and output(s): betted
#&gt; (2019-04-28 23:55:15) [DEBUG] Adding process with inputs: betted and output(s): segmentation
#&gt; (2019-04-28 23:55:15) [DEBUG] Adding process with inputs: betted and output(s): parcellation_basic
#&gt; (2019-04-28 23:55:15) [DEBUG] Adding process with inputs: parcellation_basic, segmentation and output(s): parcellation
#&gt; (2019-04-28 23:55:15) [DEBUG] Adding process with inputs: brain_mask and output(s): brain_volume_mni
#&gt; (2019-04-28 23:55:15) [DEBUG] Adding process with inputs: brain_volume_mni, scale_parameter and output(s): brain_volume
#&gt; (2019-04-28 23:55:16) [DEBUG] Adding process with inputs: segmentation and output(s): basic_volumetry_mni
#&gt; (2019-04-28 23:55:16) [DEBUG] Adding process with inputs: basic_volumetry_mni, scale_parameter and output(s): basic_volumetry
#&gt; (2019-04-28 23:55:16) [DEBUG] Adding process with inputs: parcellation and output(s): final_volumetry_mni
#&gt; (2019-04-28 23:55:16) [DEBUG] Adding process with inputs: final_volumetry_mni, scale_parameter and output(s): final_volumetry
#&gt; (2019-04-28 23:55:17) [DEBUG] Reading input T1 from file ./resources/volumetry/input/t1.nii.gz
#&gt; (2019-04-28 23:55:21) [DEBUG] Memory used at init: 57.78 MB
#&gt; (2019-04-28 23:55:21) [DEBUG] Switching tempdir to: /Users/domingo/flow/volumetry
#&gt; (2019-04-28 23:55:21) [DEBUG] Computing transformation...
#&gt; (2019-04-28 23:55:32) [DEBUG] Memory used after computation: 57.78 MB
#&gt; (2019-04-28 23:55:32) [DEBUG] Removed intermediate outputs: T1
#&gt; (2019-04-28 23:55:32) [DEBUG] Memory used after cleanup: 3.06 kB
#&gt; (2019-04-28 23:55:32) [DEBUG] Computing T1_MNI...
#&gt; (2019-04-28 23:55:38) [DEBUG] Memory used after computation: 57.78 MB
#&gt; (2019-04-28 23:55:41) [DEBUG] Computing T1_bfc...
#&gt; (2019-04-28 23:56:21) [DEBUG] Memory used after computation: 115.56 MB
#&gt; (2019-04-28 23:56:25) [DEBUG] Removed intermediate outputs: T1_MNI
#&gt; (2019-04-28 23:56:25) [DEBUG] Memory used after cleanup: 57.78 MB
#&gt; (2019-04-28 23:56:25) [DEBUG] Computing brain_mask...
#&gt; (2019-04-29 00:06:32) [DEBUG] Memory used after computation: 115.56 MB
#&gt; (2019-04-29 00:06:35) [DEBUG] Computing betted...
#&gt; (2019-04-29 00:06:36) [DEBUG] Memory used after computation: 173.33 MB
#&gt; (2019-04-29 00:06:38) [DEBUG] Computing segmentation...
#&gt; (2019-04-29 00:09:28) [DEBUG] Memory used after computation: 202.23 MB
#&gt; (2019-04-29 00:09:31) [DEBUG] Computing parcellation_basic...
#&gt; (2019-04-29 00:20:46) [DEBUG] Memory used after computation: 260 MB
#&gt; (2019-04-29 00:20:47) [DEBUG] Removed intermediate outputs: betted
#&gt; (2019-04-29 00:20:48) [DEBUG] Memory used after cleanup: 202.23 MB
#&gt; (2019-04-29 00:20:48) [DEBUG] Computing parcellation...
#&gt; (2019-04-29 00:20:48) [DEBUG] Memory used after computation: 260 MB
#&gt; (2019-04-29 00:20:51) [DEBUG] Removed intermediate outputs: parcellation_basic
#&gt; (2019-04-29 00:20:51) [DEBUG] Memory used after cleanup: 202.23 MB
#&gt; (2019-04-29 00:20:51) [DEBUG] Computing affine_transform...
#&gt; (2019-04-29 00:20:51) [DEBUG] Memory used after computation: 202.23 MB
#&gt; (2019-04-29 00:20:51) [DEBUG] Removed intermediate outputs: transformation
#&gt; (2019-04-29 00:20:52) [DEBUG] Memory used after cleanup: 202.22 MB
#&gt; (2019-04-29 00:20:52) [DEBUG] Computing scale_parameter...
#&gt; (2019-04-29 00:20:52) [DEBUG] Memory used after computation: 202.22 MB
#&gt; (2019-04-29 00:20:52) [DEBUG] Removed intermediate outputs: affine_transform
#&gt; (2019-04-29 00:20:52) [DEBUG] Memory used after cleanup: 202.22 MB
#&gt; (2019-04-29 00:20:52) [DEBUG] Computing brain_volume_mni...
#&gt; (2019-04-29 00:20:53) [DEBUG] Memory used after computation: 202.22 MB
#&gt; (2019-04-29 00:20:53) [DEBUG] Computing brain_volume...
#&gt; (2019-04-29 00:20:53) [DEBUG] Memory used after computation: 202.22 MB
#&gt; (2019-04-29 00:20:53) [DEBUG] Removed intermediate outputs: brain_volume_mni
#&gt; (2019-04-29 00:20:54) [DEBUG] Memory used after cleanup: 202.22 MB
#&gt; (2019-04-29 00:20:54) [DEBUG] Computing basic_volumetry_mni...
#&gt; (2019-04-29 00:20:54) [DEBUG] Memory used after computation: 202.23 MB
#&gt; (2019-04-29 00:20:54) [DEBUG] Computing basic_volumetry...
#&gt; (2019-04-29 00:20:54) [DEBUG] Memory used after computation: 202.23 MB
#&gt; (2019-04-29 00:20:54) [DEBUG] Removed intermediate outputs: basic_volumetry_mni
#&gt; (2019-04-29 00:20:54) [DEBUG] Memory used after cleanup: 202.23 MB
#&gt; (2019-04-29 00:20:54) [DEBUG] Computing final_volumetry_mni...
#&gt; (2019-04-29 00:20:54) [DEBUG] Memory used after computation: 202.23 MB
#&gt; (2019-04-29 00:20:54) [DEBUG] Computing final_volumetry...
#&gt; (2019-04-29 00:20:54) [DEBUG] Memory used after computation: 202.23 MB
#&gt; (2019-04-29 00:20:54) [DEBUG] Removed intermediate outputs: scale_parameter, final_volumetry_mni
#&gt; (2019-04-29 00:20:54) [DEBUG] Memory used after cleanup: 202.23 MB
#&gt; (2019-04-29 00:20:54) [DEBUG] Switching to base tempdir
#&gt; (2019-04-29 00:20:54) [DEBUG] Computed all results</code></pre>
</div>
</div>
<div id="annex-full-code" class="section level1">
<h1 class="hasAnchor">
<a href="#annex-full-code" class="anchor"></a>Annex: Full Code</h1>
<p>In this annex, we provide example code for the volumetry workflow, which can be loaded and used to replicate the workflow and results given in this vignette.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" data-line-number="1"><span class="co"># - register to a template (MNI152 in case of structural imaging)</span></a>
<a class="sourceLine" id="cb40-2" data-line-number="2"><span class="co"># Returns the transformation, as declared in the ANTsRCore package</span></a>
<a class="sourceLine" id="cb40-3" data-line-number="3">register_to_template &lt;-<span class="st"> </span><span class="cf">function</span>(image, template) {</a>
<a class="sourceLine" id="cb40-4" data-line-number="4"></a>
<a class="sourceLine" id="cb40-5" data-line-number="5">  image &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ANTsRCore/topics/check_ants-methods">check_ants</a></span>(image)</a>
<a class="sourceLine" id="cb40-6" data-line-number="6"></a>
<a class="sourceLine" id="cb40-7" data-line-number="7">  template &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ANTsRCore/topics/check_ants-methods">check_ants</a></span>(template)</a>
<a class="sourceLine" id="cb40-8" data-line-number="8"></a>
<a class="sourceLine" id="cb40-9" data-line-number="9">  transform &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ANTsRCore/topics/antsRegistration">antsRegistration</a></span>(<span class="dt">fixed =</span> template,</a>
<a class="sourceLine" id="cb40-10" data-line-number="10">                                <span class="dt">moving =</span> image,</a>
<a class="sourceLine" id="cb40-11" data-line-number="11">                                <span class="dt">typeofTransform =</span> <span class="st">"AffineFast"</span>,</a>
<a class="sourceLine" id="cb40-12" data-line-number="12">                                <span class="dt">verbose =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb40-13" data-line-number="13"></a>
<a class="sourceLine" id="cb40-14" data-line-number="14">  <span class="kw">return</span>(transform)</a>
<a class="sourceLine" id="cb40-15" data-line-number="15"></a>
<a class="sourceLine" id="cb40-16" data-line-number="16">}</a>
<a class="sourceLine" id="cb40-17" data-line-number="17"></a>
<a class="sourceLine" id="cb40-18" data-line-number="18"><span class="co"># Returns the image reoriented in the template space</span></a>
<a class="sourceLine" id="cb40-19" data-line-number="19">get_img_in_template &lt;-<span class="st"> </span><span class="cf">function</span>(tx) {</a>
<a class="sourceLine" id="cb40-20" data-line-number="20"></a>
<a class="sourceLine" id="cb40-21" data-line-number="21">  <span class="kw"><a href="http://www.rdocumentation.org/packages/neurobase/topics/check_nifti-methods">check_nifti</a></span>(tx<span class="op">$</span>warpedmovout)</a>
<a class="sourceLine" id="cb40-22" data-line-number="22"></a>
<a class="sourceLine" id="cb40-23" data-line-number="23">}</a>
<a class="sourceLine" id="cb40-24" data-line-number="24"></a>
<a class="sourceLine" id="cb40-25" data-line-number="25"><span class="co"># Returns the affine transformation</span></a>
<a class="sourceLine" id="cb40-26" data-line-number="26">get_tx_to_template &lt;-<span class="st"> </span><span class="cf">function</span>(tx) {</a>
<a class="sourceLine" id="cb40-27" data-line-number="27"></a>
<a class="sourceLine" id="cb40-28" data-line-number="28">  <span class="kw">matrix</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/extrantsr/topics/read_transformlist">read_transformlist</a></span>(tx<span class="op">$</span>fwdtransforms)[[<span class="dv">1</span>]]<span class="op">$</span>AffineTransform.float.<span class="fl">3.3</span>[<span class="dv">1</span><span class="op">:</span><span class="dv">9</span>],</a>
<a class="sourceLine" id="cb40-29" data-line-number="29">         <span class="dt">nrow =</span> <span class="dv">3</span>, <span class="dt">ncol =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb40-30" data-line-number="30"></a>
<a class="sourceLine" id="cb40-31" data-line-number="31">}</a>
<a class="sourceLine" id="cb40-32" data-line-number="32"></a>
<a class="sourceLine" id="cb40-33" data-line-number="33"><span class="co"># Returns the scale parameter as the determinant of the affine transformation</span></a>
<a class="sourceLine" id="cb40-34" data-line-number="34">get_scale_parameter &lt;-<span class="st"> </span><span class="cf">function</span>(M) {</a>
<a class="sourceLine" id="cb40-35" data-line-number="35"></a>
<a class="sourceLine" id="cb40-36" data-line-number="36">  <span class="kw">det</span>(M)</a>
<a class="sourceLine" id="cb40-37" data-line-number="37"></a>
<a class="sourceLine" id="cb40-38" data-line-number="38">}</a></code></pre></div>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" data-line-number="1"><span class="co"># - bias field correction, just a simple wrapper around</span></a>
<a class="sourceLine" id="cb41-2" data-line-number="2"><span class="co"># n4BiasFieldCorrection</span></a>
<a class="sourceLine" id="cb41-3" data-line-number="3">bfc &lt;-<span class="st"> </span><span class="cf">function</span>(img) {</a>
<a class="sourceLine" id="cb41-4" data-line-number="4"></a>
<a class="sourceLine" id="cb41-5" data-line-number="5">  image2 &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ANTsRCore/topics/as.antsImage">as.antsImage</a></span>(img)</a>
<a class="sourceLine" id="cb41-6" data-line-number="6"></a>
<a class="sourceLine" id="cb41-7" data-line-number="7">  image2 &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ANTsRCore/topics/n4BiasFieldCorrection">n4BiasFieldCorrection</a></span>(<span class="dt">img =</span> image2, <span class="dt">verbose =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb41-8" data-line-number="8"></a>
<a class="sourceLine" id="cb41-9" data-line-number="9">  <span class="kw">return</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/extrantsr/topics/ants2oro">ants2oro</a></span>(image2, <span class="dt">reference =</span> img))</a>
<a class="sourceLine" id="cb41-10" data-line-number="10"></a>
<a class="sourceLine" id="cb41-11" data-line-number="11">}</a></code></pre></div>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" data-line-number="1"><span class="co"># - brain extraction</span></a>
<a class="sourceLine" id="cb42-2" data-line-number="2"><span class="co"># Uses MALF technique with a "brain extraction" dataset</span></a>
<a class="sourceLine" id="cb42-3" data-line-number="3"><span class="co"># Returns the brain mask</span></a>
<a class="sourceLine" id="cb42-4" data-line-number="4">make_brain_extraction &lt;-<span class="st"> </span><span class="cf">function</span>(image, </a>
<a class="sourceLine" id="cb42-5" data-line-number="5">                                  template_images, </a>
<a class="sourceLine" id="cb42-6" data-line-number="6">                                  template_structs) {</a>
<a class="sourceLine" id="cb42-7" data-line-number="7"></a>
<a class="sourceLine" id="cb42-8" data-line-number="8">  my_image &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/neurobase/topics/checkimg-methods">checkimg</a></span>(image)</a>
<a class="sourceLine" id="cb42-9" data-line-number="9"></a>
<a class="sourceLine" id="cb42-10" data-line-number="10">  res &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/extrantsr/topics/malf">malf</a></span>(<span class="dt">infile =</span> my_image,</a>
<a class="sourceLine" id="cb42-11" data-line-number="11">              <span class="dt">template.images =</span> template_images,</a>
<a class="sourceLine" id="cb42-12" data-line-number="12">              <span class="dt">template.structs =</span> template_structs,</a>
<a class="sourceLine" id="cb42-13" data-line-number="13">              <span class="dt">typeofTransform =</span> <span class="st">"SyN"</span>,</a>
<a class="sourceLine" id="cb42-14" data-line-number="14">              <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb42-15" data-line-number="15"></a>
<a class="sourceLine" id="cb42-16" data-line-number="16">  <span class="kw">return</span>(res)</a>
<a class="sourceLine" id="cb42-17" data-line-number="17"></a>
<a class="sourceLine" id="cb42-18" data-line-number="18">}</a></code></pre></div>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb43-1" data-line-number="1"><span class="co"># - segmentation (GM, WM an CSF)</span></a>
<a class="sourceLine" id="cb43-2" data-line-number="2"><span class="co"># Uses FSL's FAST tool to find a segmentation into GM, WM and CSF</span></a>
<a class="sourceLine" id="cb43-3" data-line-number="3"><span class="co"># Returns the segmentation as a labelled image with labels 0 (background),</span></a>
<a class="sourceLine" id="cb43-4" data-line-number="4"><span class="co"># 1 (CSF), 2 (GM) and 3 (WM)</span></a>
<a class="sourceLine" id="cb43-5" data-line-number="5">get_segmentation &lt;-<span class="st"> </span><span class="cf">function</span>(img, <span class="dt">mask =</span> <span class="ot">NULL</span>) {</a>
<a class="sourceLine" id="cb43-6" data-line-number="6"></a>
<a class="sourceLine" id="cb43-7" data-line-number="7">  <span class="cf">if</span> (<span class="op">!</span><span class="kw">is.null</span>(mask)) {</a>
<a class="sourceLine" id="cb43-8" data-line-number="8"></a>
<a class="sourceLine" id="cb43-9" data-line-number="9">    input &lt;-<span class="st"> </span>img</a>
<a class="sourceLine" id="cb43-10" data-line-number="10">    input[mask <span class="op">==</span><span class="st"> </span><span class="dv">0</span>] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb43-11" data-line-number="11"></a>
<a class="sourceLine" id="cb43-12" data-line-number="12">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb43-13" data-line-number="13"></a>
<a class="sourceLine" id="cb43-14" data-line-number="14">    input &lt;-<span class="st"> </span>img</a>
<a class="sourceLine" id="cb43-15" data-line-number="15"></a>
<a class="sourceLine" id="cb43-16" data-line-number="16">  }</a>
<a class="sourceLine" id="cb43-17" data-line-number="17"></a>
<a class="sourceLine" id="cb43-18" data-line-number="18">  my_file &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/neurobase/topics/tempimg">tempimg</a></span>(input)</a>
<a class="sourceLine" id="cb43-19" data-line-number="19"></a>
<a class="sourceLine" id="cb43-20" data-line-number="20">  res_file &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/fslr/topics/fast">fsl_fast_nobias</a></span>(<span class="dt">file =</span> my_file, <span class="dt">retimg =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb43-21" data-line-number="21"></a>
<a class="sourceLine" id="cb43-22" data-line-number="22">  res_file &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="dt">pattern =</span> <span class="st">".nii.gz"</span>,</a>
<a class="sourceLine" id="cb43-23" data-line-number="23">                   <span class="dt">replacement =</span> <span class="st">""</span>,</a>
<a class="sourceLine" id="cb43-24" data-line-number="24">                   <span class="dt">x =</span> res_file)</a>
<a class="sourceLine" id="cb43-25" data-line-number="25"></a>
<a class="sourceLine" id="cb43-26" data-line-number="26">  res_file &lt;-<span class="st"> </span><span class="kw">paste0</span>(res_file, <span class="st">"_pveseg.nii.gz"</span>)</a>
<a class="sourceLine" id="cb43-27" data-line-number="27"></a>
<a class="sourceLine" id="cb43-28" data-line-number="28">  <span class="kw">return</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/neurobase/topics/check_nifti-methods">check_nifti</a></span>(res_file))</a>
<a class="sourceLine" id="cb43-29" data-line-number="29"></a>
<a class="sourceLine" id="cb43-30" data-line-number="30">}</a></code></pre></div>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" data-line-number="1"><span class="co"># Remaps labels given by values = (l1, l2, l3, ...) present in the image img</span></a>
<a class="sourceLine" id="cb44-2" data-line-number="2"><span class="co"># to numbers (1, 2, 3, ...) to make MALF easier.</span></a>
<a class="sourceLine" id="cb44-3" data-line-number="3">remap_labels &lt;-<span class="st"> </span><span class="cf">function</span>(img, <span class="dt">values =</span> <span class="ot">NULL</span>) {</a>
<a class="sourceLine" id="cb44-4" data-line-number="4"></a>
<a class="sourceLine" id="cb44-5" data-line-number="5">  <span class="cf">if</span> (<span class="kw">is.null</span>(values)) {</a>
<a class="sourceLine" id="cb44-6" data-line-number="6"></a>
<a class="sourceLine" id="cb44-7" data-line-number="7">    values &lt;-<span class="st"> </span>img <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.vector</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unique</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sort</span>()</a>
<a class="sourceLine" id="cb44-8" data-line-number="8">    values &lt;-<span class="st"> </span>values[values <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>]</a>
<a class="sourceLine" id="cb44-9" data-line-number="9"></a>
<a class="sourceLine" id="cb44-10" data-line-number="10">  }</a>
<a class="sourceLine" id="cb44-11" data-line-number="11"></a>
<a class="sourceLine" id="cb44-12" data-line-number="12">  res &lt;-<span class="st"> </span><span class="dv">0</span> <span class="op">*</span><span class="st"> </span>img</a>
<a class="sourceLine" id="cb44-13" data-line-number="13"></a>
<a class="sourceLine" id="cb44-14" data-line-number="14">  <span class="cf">for</span> (k <span class="cf">in</span> <span class="kw">seq_along</span>(values)) {</a>
<a class="sourceLine" id="cb44-15" data-line-number="15"></a>
<a class="sourceLine" id="cb44-16" data-line-number="16">    res[img <span class="op">==</span><span class="st"> </span>values[k]] &lt;-<span class="st"> </span>k</a>
<a class="sourceLine" id="cb44-17" data-line-number="17"></a>
<a class="sourceLine" id="cb44-18" data-line-number="18">  }</a>
<a class="sourceLine" id="cb44-19" data-line-number="19"></a>
<a class="sourceLine" id="cb44-20" data-line-number="20">  <span class="kw">return</span>(res)</a>
<a class="sourceLine" id="cb44-21" data-line-number="21"></a>
<a class="sourceLine" id="cb44-22" data-line-number="22">}</a></code></pre></div>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb45-1" data-line-number="1"><span class="co"># - parcellation</span></a>
<a class="sourceLine" id="cb45-2" data-line-number="2"><span class="co"># Uses MALF technique with a previously labelled dataset</span></a>
<a class="sourceLine" id="cb45-3" data-line-number="3">make_subcortical_parcellation &lt;-<span class="st"> </span><span class="cf">function</span>(image,</a>
<a class="sourceLine" id="cb45-4" data-line-number="4">                                          <span class="dt">mask =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb45-5" data-line-number="5">                                          template_images,</a>
<a class="sourceLine" id="cb45-6" data-line-number="6">                                          template_structs) {</a>
<a class="sourceLine" id="cb45-7" data-line-number="7"></a>
<a class="sourceLine" id="cb45-8" data-line-number="8">  num_subjects &lt;-<span class="st"> </span><span class="kw">length</span>(template_images)</a>
<a class="sourceLine" id="cb45-9" data-line-number="9"></a>
<a class="sourceLine" id="cb45-10" data-line-number="10">  <span class="co"># Subcortical structures labels</span></a>
<a class="sourceLine" id="cb45-11" data-line-number="11">  retain_structs &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">10</span>, <span class="dv">11</span>, <span class="dv">12</span>, <span class="dv">13</span>, <span class="dv">17</span>, <span class="dv">18</span>, <span class="dv">49</span><span class="op">:</span><span class="dv">54</span>)</a>
<a class="sourceLine" id="cb45-12" data-line-number="12"></a>
<a class="sourceLine" id="cb45-13" data-line-number="13">  <span class="co"># Read label images</span></a>
<a class="sourceLine" id="cb45-14" data-line-number="14">  out &lt;-<span class="st"> </span><span class="kw">lapply</span>(template_structs, readnii)</a>
<a class="sourceLine" id="cb45-15" data-line-number="15">  out1 &lt;-<span class="st"> </span>out[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb45-16" data-line-number="16"></a>
<a class="sourceLine" id="cb45-17" data-line-number="17">  <span class="co"># Remap subcortical labels to 1, 2, ...</span></a>
<a class="sourceLine" id="cb45-18" data-line-number="18">  out2 &lt;-<span class="st"> </span><span class="kw">lapply</span>(out,</a>
<a class="sourceLine" id="cb45-19" data-line-number="19">                 <span class="cf">function</span>(s) <span class="kw">remap_labels</span>(s<span class="op">@</span>.Data,</a>
<a class="sourceLine" id="cb45-20" data-line-number="20">                                          <span class="dt">values =</span> retain_structs))</a>
<a class="sourceLine" id="cb45-21" data-line-number="21"></a>
<a class="sourceLine" id="cb45-22" data-line-number="22">  <span class="co"># Save the remapped images to file</span></a>
<a class="sourceLine" id="cb45-23" data-line-number="23">  my_outputs &lt;-<span class="st"> </span><span class="kw">sapply</span>(<span class="kw">seq</span>(num_subjects),</a>
<a class="sourceLine" id="cb45-24" data-line-number="24">                       <span class="cf">function</span>(i) {</a>
<a class="sourceLine" id="cb45-25" data-line-number="25"></a>
<a class="sourceLine" id="cb45-26" data-line-number="26">                         out1<span class="op">@</span>.Data &lt;-<span class="st"> </span>out2[[i]]</a>
<a class="sourceLine" id="cb45-27" data-line-number="27"></a>
<a class="sourceLine" id="cb45-28" data-line-number="28">                         <span class="kw"><a href="http://www.rdocumentation.org/packages/neurobase/topics/tempimg">tempimg</a></span>(<span class="dt">nim =</span> out1)</a>
<a class="sourceLine" id="cb45-29" data-line-number="29"></a>
<a class="sourceLine" id="cb45-30" data-line-number="30">                       })</a>
<a class="sourceLine" id="cb45-31" data-line-number="31"></a>
<a class="sourceLine" id="cb45-32" data-line-number="32">  <span class="cf">if</span> (<span class="op">!</span><span class="kw">is.null</span>(mask)) {</a>
<a class="sourceLine" id="cb45-33" data-line-number="33"></a>
<a class="sourceLine" id="cb45-34" data-line-number="34">    input &lt;-<span class="st"> </span>image</a>
<a class="sourceLine" id="cb45-35" data-line-number="35">    input[mask <span class="op">==</span><span class="st"> </span><span class="dv">0</span>] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb45-36" data-line-number="36"></a>
<a class="sourceLine" id="cb45-37" data-line-number="37">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb45-38" data-line-number="38"></a>
<a class="sourceLine" id="cb45-39" data-line-number="39">    input &lt;-<span class="st"> </span>image</a>
<a class="sourceLine" id="cb45-40" data-line-number="40"></a>
<a class="sourceLine" id="cb45-41" data-line-number="41">  }</a>
<a class="sourceLine" id="cb45-42" data-line-number="42"></a>
<a class="sourceLine" id="cb45-43" data-line-number="43">  <span class="co"># Apply MALF</span></a>
<a class="sourceLine" id="cb45-44" data-line-number="44">  res &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/extrantsr/topics/malf">malf</a></span>(<span class="dt">infile =</span> input,</a>
<a class="sourceLine" id="cb45-45" data-line-number="45">                         <span class="dt">template.images =</span> template_images,</a>
<a class="sourceLine" id="cb45-46" data-line-number="46">                         <span class="dt">template.structs =</span> my_outputs,</a>
<a class="sourceLine" id="cb45-47" data-line-number="47">                         <span class="dt">typeofTransform =</span> <span class="st">"SyN"</span>,</a>
<a class="sourceLine" id="cb45-48" data-line-number="48">                         <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb45-49" data-line-number="49"></a>
<a class="sourceLine" id="cb45-50" data-line-number="50">  <span class="kw">return</span>(res)</a>
<a class="sourceLine" id="cb45-51" data-line-number="51"></a>
<a class="sourceLine" id="cb45-52" data-line-number="52">}</a>
<a class="sourceLine" id="cb45-53" data-line-number="53"></a>
<a class="sourceLine" id="cb45-54" data-line-number="54"><span class="co"># Removes CSF voxels from the parcellation</span></a>
<a class="sourceLine" id="cb45-55" data-line-number="55">refine_parcellation &lt;-<span class="st"> </span><span class="cf">function</span>(parcellation, segmentation) {</a>
<a class="sourceLine" id="cb45-56" data-line-number="56"></a>
<a class="sourceLine" id="cb45-57" data-line-number="57">  parcellation[segmentation <span class="op">&lt;=</span><span class="st"> </span><span class="dv">1</span>] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb45-58" data-line-number="58"></a>
<a class="sourceLine" id="cb45-59" data-line-number="59">  <span class="kw">return</span>(parcellation)</a>
<a class="sourceLine" id="cb45-60" data-line-number="60"></a>
<a class="sourceLine" id="cb45-61" data-line-number="61">}</a></code></pre></div>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb46-1" data-line-number="1">count_by_ROI &lt;-<span class="st"> </span><span class="cf">function</span>(img) {</a>
<a class="sourceLine" id="cb46-2" data-line-number="2"></a>
<a class="sourceLine" id="cb46-3" data-line-number="3">  v &lt;-<span class="st"> </span>img <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.vector</span>()</a>
<a class="sourceLine" id="cb46-4" data-line-number="4">  <span class="kw">table</span>(v[v <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>])</a>
<a class="sourceLine" id="cb46-5" data-line-number="5"></a>
<a class="sourceLine" id="cb46-6" data-line-number="6">}</a></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#objective">Objective</a></li>
      <li>
<a href="#requirements">Requirements</a><ul class="nav nav-pills nav-stacked">
<li><a href="#packages">Packages</a></li>
      <li><a href="#other-resources">Other Resources</a></li>
      </ul>
</li>
      <li>
<a href="#volumetry">Volumetry</a><ul class="nav nav-pills nav-stacked">
<li><a href="#register-to-template-space">Register to Template Space</a></li>
      <li><a href="#bias-field-correction">Bias Field Correction</a></li>
      <li><a href="#brain-extraction">Brain Extraction</a></li>
      <li><a href="#segmentation">Segmentation</a></li>
      <li><a href="#anatomical-parcellation">Anatomical Parcellation</a></li>
      <li><a href="#quantification">Quantification</a></li>
      </ul>
</li>
      <li><a href="#final-flow">Final Flow</a></li>
      <li>
<a href="#example">Example</a><ul class="nav nav-pills nav-stacked">
<li><a href="#code">Code</a></li>
      <li><a href="#results">Results</a></li>
      <li><a href="#images">Images</a></li>
      <li><a href="#full-flow-log">Full Flow Log</a></li>
      </ul>
</li>
      <li><a href="#annex-full-code">Annex: Full Code</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Domingo Lopez-Rodriguez.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
