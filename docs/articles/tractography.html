<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using <code>wf4ni</code> to Compute Tractography • wf4ni</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using &lt;code&gt;wf4ni&lt;/code&gt; to Compute Tractography">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">wf4ni</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/wf4ni.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/rsfmri.html">Using `wf4ni` for Resting State fMRI processing</a>
    </li>
    <li>
      <a href="../articles/tractography.html">Using `wf4ni` to Compute Tractography</a>
    </li>
    <li>
      <a href="../articles/volumetry.html">Using `wf4ni` to Build a Volumetry Flow</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/neuroimaginador/wf4ni">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Using <code>wf4ni</code> to Compute Tractography</h1>
                        <h4 class="author">Domingo López-Rodríguez</h4>
            
            <h4 class="date">2019-05-07</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/neuroimaginador/wf4ni/blob/master/vignettes/tractography.Rmd"><code>vignettes/tractography.Rmd</code></a></small>
      <div class="hidden name"><code>tractography.Rmd</code></div>

    </div>

    
    
<div id="objective" class="section level1">
<h1 class="hasAnchor">
<a href="#objective" class="anchor"></a>Objective</h1>
<p>In this vignette, we’re going to develop a pipeline (workflow) to build the deterministic tractography from a diffusion image, using the <code>wf4ni</code> package.</p>
<p>The main steps in this pipeline will be:</p>
<ul>
<li>Eddy current correction.</li>
<li>Tensor computation.</li>
<li>Fiber tracking inside a mask.</li>
<li>Computation of Fractional Anisotropy (FA) map.</li>
</ul>
<p>To demonstrate the flexibility of <code>wf4ni</code>, we’ll use different <code>R</code> packages to perform several of the above steps.</p>
<p>It must be noted that the philosophy of <code>wf4ni</code> is to separate the pipeline logic from its implementation. So, the same workflow could be used just changing, if needed, the implementation of any (or all) of the steps above.</p>
<p>The organization of this vignette is as follows. First, we’ll describe the dependencies or packages needed to run the workflow. Later, we’ll describe the workflow, step by step, without presenting the actual implementation of the functions used. Then, we’ll use some sample data to run an experiment with the workflow, presenting its results. We’ll end the vignette with an annex in which we’ll present the actual implementation of the functions.</p>
</div>
<div id="requirements" class="section level1">
<h1 class="hasAnchor">
<a href="#requirements" class="anchor"></a>Requirements</h1>
<p>We consider two types of requirements: packages needed to perform the key steps in the workflow and data which may be necessary at any step of the computation.</p>
<div id="packages" class="section level2">
<h2 class="hasAnchor">
<a href="#packages" class="anchor"></a>Packages</h2>
<p>First, to build the flow, the <code>wf4ni</code> package is needed:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(wf4ni)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="co">#&gt; Attaching package: 'wf4ni'</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="co">#&gt; The following object is masked from 'package:base':</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="co">#&gt;     merge</span></a></code></pre></div>
<p>The following packages are needed in some points of the pipeline:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="kw">library</span>(neurobase)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="kw">library</span>(oro.nifti)</a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="kw">library</span>(fslr)</a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="kw">library</span>(dti)</a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="kw">library</span>(readr)</a></code></pre></div>
<p><code>fslr</code> and <code>dti</code> will be used for the processing, while <code>neurobase</code>, <code>oro.nifti</code> and <code>readr</code> will be used for reading and writing files. The <code>tidyverse</code> is useful to simplify some code and make it more legible.</p>
</div>
<div id="other-resources" class="section level2">
<h2 class="hasAnchor">
<a href="#other-resources" class="anchor"></a>Other Resources</h2>
<p>In this case, we are not using any other external data for this pipeline.</p>
</div>
</div>
<div id="dti-processing" class="section level1">
<h1 class="hasAnchor">
<a href="#dti-processing" class="anchor"></a>DTI Processing</h1>
<p>The diffusion workflow will be a <code>NIflow</code> object. To create such object, one needs to provide a <em>name</em>, a <em>work_dir</em> where to store temporary results, and the name of the <em>inputs</em> needed to execute the workflow. In this case, our pipeline will need:</p>
<ul>
<li>A DWI image in nifti format.</li>
<li>A matrix of gradient directions with which the DWI image was obtained.</li>
<li>A vector of b-values for each acquisition in the DWI image.</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">dti_flow &lt;-<span class="st"> </span>NIflow<span class="op">$</span><span class="kw">new</span>(<span class="dt">name =</span> <span class="st">"dti"</span>,</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">                       <span class="dt">work_dir =</span> <span class="st">"~/flow/dti"</span>,</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">                       <span class="dt">inputs =</span> <span class="kw">c</span>(<span class="st">"dwi"</span>, <span class="st">"grads"</span>, <span class="st">"bvals"</span>))</a></code></pre></div>
<div id="eddy-current-correction" class="section level2">
<h2 class="hasAnchor">
<a href="#eddy-current-correction" class="anchor"></a>Eddy Current Correction</h2>
<p>The first step will be to correct the effect of eddy currents in the diffusion acquisition. We’ll use the <code>fslr</code> package to this end.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">correct_dwi &lt;-<span class="st"> </span><span class="cf">function</span>(image) {</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">  <span class="co">#...</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3">}</a></code></pre></div>
<p>This function is added to the flow a follows:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">dti_flow <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> correct_dwi,</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">      <span class="dt">inputs =</span> <span class="st">"dwi"</span>,</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">      <span class="dt">output =</span> <span class="st">"dwi_corrected"</span>)</a></code></pre></div>
<p>And a graph representation of this partial flow:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">dti_flow<span class="op">$</span><span class="kw"><a href="../reference/plot.html">plot</a></span>()</a></code></pre></div>
<p><img src="tractography_files/figure-html/unnamed-chunk-3-1.png" width="480"></p>
</div>
<div id="tensor-computation" class="section level2">
<h2 class="hasAnchor">
<a href="#tensor-computation" class="anchor"></a>Tensor Computation</h2>
<p>The next step is to incorporate the gradient directions and the b-values in an object suitable to perform the tensor computation by the <code>dti</code> package.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">read_data &lt;-<span class="st"> </span><span class="cf">function</span>(image, grads, bvals) {</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">  <span class="co">#...</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3">}</a>
<a class="sourceLine" id="cb7-4" data-line-number="4"></a>
<a class="sourceLine" id="cb7-5" data-line-number="5">compute_tensors &lt;-<span class="st"> </span><span class="cf">function</span>(dwi_data) {</a>
<a class="sourceLine" id="cb7-6" data-line-number="6">  <span class="co">#...</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7">}</a></code></pre></div>
<p>And the way to include these functions in the flow is:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">dti_flow <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> read_data,</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">      <span class="dt">inputs =</span> <span class="kw">c</span>(<span class="st">"dwi_corrected"</span>, <span class="st">"grads"</span>, <span class="st">"bvals"</span>),</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">      <span class="dt">output =</span> <span class="st">"dwiData"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> compute_tensors,</a>
<a class="sourceLine" id="cb8-6" data-line-number="6">      <span class="dt">inputs =</span> <span class="st">"dwiData"</span>,</a>
<a class="sourceLine" id="cb8-7" data-line-number="7">      <span class="dt">output =</span> <span class="st">"tensors"</span>)</a></code></pre></div>
<p>The partial flow is:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">dti_flow<span class="op">$</span><span class="kw"><a href="../reference/plot.html">plot</a></span>()</a></code></pre></div>
<p><img src="tractography_files/figure-html/unnamed-chunk-4-1.png" width="480"></p>
</div>
<div id="mask-computation" class="section level2">
<h2 class="hasAnchor">
<a href="#mask-computation" class="anchor"></a>Mask Computation</h2>
<p>Using tensor information, we can extract the <em>S0</em> image (the average of the images acquired without gradient) and the mask (using the <code>fslr</code> package):</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">get_S0 &lt;-<span class="st"> </span><span class="cf">function</span>(tensors) {</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">  <span class="co">#...</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3">}</a>
<a class="sourceLine" id="cb10-4" data-line-number="4"></a>
<a class="sourceLine" id="cb10-5" data-line-number="5">compute_mask &lt;-<span class="st"> </span><span class="cf">function</span>(S0) {</a>
<a class="sourceLine" id="cb10-6" data-line-number="6">  <span class="co">#...</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7">}</a></code></pre></div>
<p>Next, we add these steps to the flow:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">dti_flow <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> get_S0,</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">      <span class="dt">inputs =</span> <span class="st">"tensors"</span>,</a>
<a class="sourceLine" id="cb11-4" data-line-number="4">      <span class="dt">output =</span> <span class="st">"S0"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> compute_mask,</a>
<a class="sourceLine" id="cb11-6" data-line-number="6">      <span class="dt">inputs =</span> <span class="st">"S0"</span>,</a>
<a class="sourceLine" id="cb11-7" data-line-number="7">      <span class="dt">output =</span> <span class="st">"mask"</span>)</a></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">dti_flow<span class="op">$</span><span class="kw"><a href="../reference/plot.html">plot</a></span>()</a></code></pre></div>
<p><img src="tractography_files/figure-html/unnamed-chunk-5-1.png" width="480"></p>
</div>
<div id="fiber-tracking" class="section level2">
<h2 class="hasAnchor">
<a href="#fiber-tracking" class="anchor"></a>Fiber Tracking</h2>
<p>One of the main results of this pipeline is to obtain the fibers associated to the tensors previously computed. We use the following function (a wrapper to a function in the <code>dti</code> package) to perform fiber tracking on the mask already calculated.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">fibertracking &lt;-<span class="st"> </span><span class="cf">function</span>(tensors, mask) {</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">  <span class="co">#...</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3">}</a></code></pre></div>
<p>And we add this step to the flow:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">dti_flow <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> fibertracking,</a>
<a class="sourceLine" id="cb14-3" data-line-number="3">      <span class="dt">inputs =</span> <span class="kw">c</span>(<span class="st">"tensors"</span>, <span class="st">"mask"</span>),</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">      <span class="dt">output =</span> <span class="st">"fibers"</span>)</a></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">dti_flow<span class="op">$</span><span class="kw"><a href="../reference/plot.html">plot</a></span>()</a></code></pre></div>
<p><img src="tractography_files/figure-html/unnamed-chunk-6-1.png" width="480"></p>
</div>
<div id="fa-map" class="section level2">
<h2 class="hasAnchor">
<a href="#fa-map" class="anchor"></a>FA Map</h2>
<p>As a side effect of the previous computations, we can compute a FA map from the tensor map (using a mask to remove non-informative voxels outside the brain). This function is also a wrapper to a function in package <code>dti</code>:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">compute_FA &lt;-<span class="st"> </span><span class="cf">function</span>(tensors, mask) {</a>
<a class="sourceLine" id="cb16-2" data-line-number="2">  <span class="co">#...</span></a>
<a class="sourceLine" id="cb16-3" data-line-number="3">}</a></code></pre></div>
<p>And, finally, we add this last step to the flow:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">dti_flow <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../reference/add.html">add</a></span>(<span class="dt">what =</span> compute_FA,</a>
<a class="sourceLine" id="cb17-3" data-line-number="3">      <span class="dt">inputs =</span> <span class="kw">c</span>(<span class="st">"tensors"</span>, <span class="st">"mask"</span>),</a>
<a class="sourceLine" id="cb17-4" data-line-number="4">      <span class="dt">output =</span> <span class="st">"FA_map"</span>)</a></code></pre></div>
</div>
</div>
<div id="final-flow" class="section level1">
<h1 class="hasAnchor">
<a href="#final-flow" class="anchor"></a>Final Flow</h1>
<p>With these final additions, the complete pipeline is as follows:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">dti_flow<span class="op">$</span><span class="kw"><a href="../reference/plot.html">plot</a></span>()</a></code></pre></div>
<p><img src="tractography_files/figure-html/flow_plot-1.png" width="672"></p>
<p>We can also obtain a brief summary of the flow by typing:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="kw">summary</span>(dti_flow)</a>
<a class="sourceLine" id="cb19-2" data-line-number="2"><span class="co">#&gt; NIflow object with:</span></a>
<a class="sourceLine" id="cb19-3" data-line-number="3"><span class="co">#&gt;   name: dti </span></a>
<a class="sourceLine" id="cb19-4" data-line-number="4"><span class="co">#&gt;   inputs: dwi, grads, bvals </span></a>
<a class="sourceLine" id="cb19-5" data-line-number="5"><span class="co">#&gt;   outputs: dwi_corrected, dwiData, tensors, S0, mask, fibers, FA_map </span></a>
<a class="sourceLine" id="cb19-6" data-line-number="6"><span class="co">#&gt; Currently using 744.82 kB of memory.</span></a>
<a class="sourceLine" id="cb19-7" data-line-number="7"><span class="co">#&gt; Summary of processes:</span></a>
<a class="sourceLine" id="cb19-8" data-line-number="8"><span class="co">#&gt;   dwi_corrected needs dwi as inputs.</span></a>
<a class="sourceLine" id="cb19-9" data-line-number="9"><span class="co">#&gt;   dwiData needs dwi_corrected, grads, bvals as inputs.</span></a>
<a class="sourceLine" id="cb19-10" data-line-number="10"><span class="co">#&gt;   tensors needs dwiData as inputs.</span></a>
<a class="sourceLine" id="cb19-11" data-line-number="11"><span class="co">#&gt;   S0 needs tensors as inputs.</span></a>
<a class="sourceLine" id="cb19-12" data-line-number="12"><span class="co">#&gt;   mask needs S0 as inputs.</span></a>
<a class="sourceLine" id="cb19-13" data-line-number="13"><span class="co">#&gt;   fibers needs tensors, mask as inputs.</span></a>
<a class="sourceLine" id="cb19-14" data-line-number="14"><span class="co">#&gt;   FA_map needs tensors, mask as inputs.</span></a></code></pre></div>
</div>
<div id="example" class="section level1">
<h1 class="hasAnchor">
<a href="#example" class="anchor"></a>Example</h1>
<p>To illustrate how this workflow can be used, let us suppose that we have all the functions mentioned before already implemented (an example implementation is given in the Annex), and build the workflow as in the previous steps. We’ll apply this flow to compute the fibers and the FA map given a DWI image.</p>
<div id="code" class="section level2">
<h2 class="hasAnchor">
<a href="#code" class="anchor"></a>Code</h2>
<p>We’ll use sample data for the DWI image (from the Human Connectome Project), and the b-values vector and gradient matrix.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1"></a>
<a class="sourceLine" id="cb20-2" data-line-number="2">dwi_file &lt;-<span class="st"> "./resources/dti/dti_example.nii.gz"</span></a>
<a class="sourceLine" id="cb20-3" data-line-number="3">bvals_file &lt;-<span class="st"> "./resources/dti/dti_bvals.csv"</span></a>
<a class="sourceLine" id="cb20-4" data-line-number="4">grads_file &lt;-<span class="st"> "./resources/dti/dti_gradients.csv"</span></a>
<a class="sourceLine" id="cb20-5" data-line-number="5"></a>
<a class="sourceLine" id="cb20-6" data-line-number="6">dwi &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/neurobase/topics/readNIfTI2">readnii</a></span>(dwi_file)</a>
<a class="sourceLine" id="cb20-7" data-line-number="7">bvals &lt;-<span class="st"> </span><span class="kw"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span>(bvals_file,</a>
<a class="sourceLine" id="cb20-8" data-line-number="8">                  <span class="dt">col_names =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb20-9" data-line-number="9">                  <span class="dt">col_types =</span> <span class="kw"><a href="https://readr.tidyverse.org/reference/cols.html">cols</a></span>()) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unlist</span>()</a>
<a class="sourceLine" id="cb20-10" data-line-number="10">gradients &lt;-<span class="st"> </span><span class="kw"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span>(grads_file,</a>
<a class="sourceLine" id="cb20-11" data-line-number="11">                      <span class="dt">col_names =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb20-12" data-line-number="12">                      <span class="dt">col_types =</span> <span class="kw"><a href="https://readr.tidyverse.org/reference/cols.html">cols</a></span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-13" data-line-number="13"><span class="st">  </span><span class="kw">as.matrix</span>()</a>
<a class="sourceLine" id="cb20-14" data-line-number="14"></a>
<a class="sourceLine" id="cb20-15" data-line-number="15">res &lt;-<span class="st"> </span>dti_flow<span class="op">$</span><span class="kw"><a href="../reference/execute.html">execute</a></span>(<span class="dt">inputs =</span> <span class="kw">list</span>(<span class="dt">dwi =</span> dwi,</a>
<a class="sourceLine" id="cb20-16" data-line-number="16">                                      <span class="dt">grads =</span> gradients,</a>
<a class="sourceLine" id="cb20-17" data-line-number="17">                                      <span class="dt">bvals =</span> bvals),</a>
<a class="sourceLine" id="cb20-18" data-line-number="18">                        <span class="dt">desired_outputs =</span> <span class="kw">c</span>(<span class="st">"S0"</span>, </a>
<a class="sourceLine" id="cb20-19" data-line-number="19">                                            <span class="st">"fibers"</span>, </a>
<a class="sourceLine" id="cb20-20" data-line-number="20">                                            <span class="st">"FA_map"</span>))</a></code></pre></div>
</div>
<div id="images" class="section level2">
<h2 class="hasAnchor">
<a href="#images" class="anchor"></a>Images</h2>
<p>Using the function <code>ortho2</code> in package <code>neurobase</code>, we can inspect both the <em>S0</em> image and the obtained FA map.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">neurobase<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/neurobase/topics/ortho2">ortho2</a></span>(res<span class="op">$</span>S0)</a></code></pre></div>
<p><img src="img/dti_S0.png" width="640"></p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1">neurobase<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/neurobase/topics/ortho2">ortho2</a></span>(res<span class="op">$</span>FA_map)</a></code></pre></div>
<p><img src="img/dti_FA_map.png" width="640"></p>
<p>Also, we can inspect the computed fiber bundles by using the native function <code>show3d</code> of package <code>dti</code>. To illustrate the results, we present some snapshots of the obtained fibers:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="kw"><a href="http://www.rdocumentation.org/packages/dti/topics/show3d-methods">show3d</a></span>(res<span class="op">$</span>fibers)</a></code></pre></div>
<p><img src="img/dti_fibers1.png" width="720"><img src="img/dti_fibers2.png" width="720"><img src="img/dti_fibers3.png" width="720"><img src="img/dti_fibers4.png" width="720"></p>
</div>
<div id="full-flow-log" class="section level2">
<h2 class="hasAnchor">
<a href="#full-flow-log" class="anchor"></a>Full Flow Log</h2>
<p>The <code>NIflow</code> object stores internally a log of all the processes that it goes through and the memory used to store its internal results:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1">dti_flow<span class="op">$</span><span class="kw">print_log</span>()</a></code></pre></div>
<pre><code>#&gt; (2019-04-28 21:07:14) [DEBUG] Adding process with inputs: dwi and output(s): dwi_corrected
#&gt; (2019-04-28 21:07:17) [DEBUG] Adding process with inputs: dwi_corrected, grads, bvals and output(s): dwiData
#&gt; (2019-04-28 21:07:17) [DEBUG] Adding process with inputs: dwiData and output(s): tensors
#&gt; (2019-04-28 21:07:18) [DEBUG] Adding process with inputs: tensors and output(s): S0
#&gt; (2019-04-28 21:07:18) [DEBUG] Adding process with inputs: S0 and output(s): mask
#&gt; (2019-04-28 21:07:19) [DEBUG] Adding process with inputs: tensors, mask and output(s): fibers
#&gt; (2019-04-28 21:07:20) [DEBUG] Adding process with inputs: tensors, mask and output(s): FA_map
#&gt; (2019-04-28 21:08:36) [DEBUG] Using provided input dwi
#&gt; (2019-04-28 21:08:36) [DEBUG] Using provided input grads
#&gt; (2019-04-28 21:08:36) [DEBUG] Using provided input bvals
#&gt; (2019-04-28 21:08:36) [DEBUG] Memory used at init: 259.54 MB
#&gt; (2019-04-28 21:08:36) [DEBUG] Switching tempdir to: ~/flow/dti
#&gt; (2019-04-28 21:08:36) [DEBUG] Computing dwi_corrected...
#&gt; (2019-04-28 21:17:02) [DEBUG] Memory used after computation: 519.07 MB
#&gt; (2019-04-28 21:17:39) [DEBUG] Removed intermediate outputs: dwi
#&gt; (2019-04-28 21:17:40) [DEBUG] Memory used after cleanup: 259.54 MB
#&gt; (2019-04-28 21:17:40) [DEBUG] Computing dwiData...
#&gt; (2019-04-28 21:18:41) [DEBUG] Memory used after computation: 519.08 MB
#&gt; (2019-04-28 21:19:12) [DEBUG] Removed intermediate outputs: grads, bvals, dwi_corrected
#&gt; (2019-04-28 21:19:12) [DEBUG] Memory used after cleanup: 259.54 MB
#&gt; (2019-04-28 21:19:12) [DEBUG] Computing tensors...
#&gt; (2019-04-28 21:21:37) [DEBUG] Memory used after computation: 328.15 MB
#&gt; (2019-04-28 21:21:40) [DEBUG] Removed intermediate outputs: dwiData
#&gt; (2019-04-28 21:21:40) [DEBUG] Memory used after cleanup: 68.61 MB
#&gt; (2019-04-28 21:21:40) [DEBUG] Computing S0...
#&gt; (2019-04-28 21:21:40) [DEBUG] Memory used after computation: 76.48 MB
#&gt; (2019-04-28 21:21:41) [DEBUG] Computing mask...
#&gt; (2019-04-28 21:21:44) [DEBUG] Memory used after computation: 80.42 MB
#&gt; (2019-04-28 21:21:44) [DEBUG] Computing fibers...
#&gt; (2019-04-28 21:21:51) [DEBUG] Memory used after computation: 117.83 MB
#&gt; (2019-04-28 21:21:53) [DEBUG] Computing FA_map...
#&gt; (2019-04-28 21:21:56) [DEBUG] Memory used after computation: 125.7 MB
#&gt; (2019-04-28 21:21:56) [DEBUG] Removed intermediate outputs: tensors, mask
#&gt; (2019-04-28 21:21:57) [DEBUG] Memory used after cleanup: 53.15 MB
#&gt; (2019-04-28 21:21:57) [DEBUG] Switching to base tempdir
#&gt; (2019-04-28 21:21:57) [DEBUG] Computed all results</code></pre>
</div>
</div>
<div id="annex-full-code" class="section level1">
<h1 class="hasAnchor">
<a href="#annex-full-code" class="anchor"></a>Annex: Full Code</h1>
<p>In this annex, we provide example code for the tractography workflow, which can be loaded and used to replicate the workflow and results given in this vignette.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1">correct_dwi &lt;-<span class="st"> </span><span class="cf">function</span>(image) {</a>
<a class="sourceLine" id="cb26-2" data-line-number="2"></a>
<a class="sourceLine" id="cb26-3" data-line-number="3">  my_dwi_file &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/neurobase/topics/tempimg">tempimg</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/oro.nifti/topics/as.nifti">as.nifti</a></span>(image))</a>
<a class="sourceLine" id="cb26-4" data-line-number="4"></a>
<a class="sourceLine" id="cb26-5" data-line-number="5">  dwi_corrected &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/fslr/topics/eddy_correct">eddy_correct</a></span>(<span class="dt">infile =</span> my_dwi_file)</a>
<a class="sourceLine" id="cb26-6" data-line-number="6"></a>
<a class="sourceLine" id="cb26-7" data-line-number="7">  <span class="kw">return</span>(dwi_corrected)</a>
<a class="sourceLine" id="cb26-8" data-line-number="8"></a>
<a class="sourceLine" id="cb26-9" data-line-number="9">}</a></code></pre></div>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1">read_data &lt;-<span class="st"> </span><span class="cf">function</span>(image, grads, bvals) {</a>
<a class="sourceLine" id="cb27-2" data-line-number="2"></a>
<a class="sourceLine" id="cb27-3" data-line-number="3">  my_dwi_corrected_file &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/neurobase/topics/tempimg">tempimg</a></span>(image)</a>
<a class="sourceLine" id="cb27-4" data-line-number="4"></a>
<a class="sourceLine" id="cb27-5" data-line-number="5">  dwi_data &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/dti/topics/readDWIdata">readDWIdata</a></span>(<span class="dt">gradient =</span> grads,</a>
<a class="sourceLine" id="cb27-6" data-line-number="6">                          <span class="dt">dirlist =</span> my_dwi_corrected_file,</a>
<a class="sourceLine" id="cb27-7" data-line-number="7">                          <span class="dt">bvalue =</span> bvals,</a>
<a class="sourceLine" id="cb27-8" data-line-number="8">                          <span class="dt">format =</span> <span class="st">"NIFTI"</span>)</a>
<a class="sourceLine" id="cb27-9" data-line-number="9"></a>
<a class="sourceLine" id="cb27-10" data-line-number="10">  <span class="kw">return</span>(dwi_data)</a>
<a class="sourceLine" id="cb27-11" data-line-number="11"></a>
<a class="sourceLine" id="cb27-12" data-line-number="12">}</a>
<a class="sourceLine" id="cb27-13" data-line-number="13"></a>
<a class="sourceLine" id="cb27-14" data-line-number="14">compute_tensors &lt;-<span class="st"> </span><span class="cf">function</span>(dwi_data) {</a>
<a class="sourceLine" id="cb27-15" data-line-number="15"></a>
<a class="sourceLine" id="cb27-16" data-line-number="16">  tensors &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/dti/topics/dtiTensor-methods">dtiTensor</a></span>(dwi_data)</a>
<a class="sourceLine" id="cb27-17" data-line-number="17"></a>
<a class="sourceLine" id="cb27-18" data-line-number="18">  <span class="kw">return</span>(tensors)</a>
<a class="sourceLine" id="cb27-19" data-line-number="19"></a>
<a class="sourceLine" id="cb27-20" data-line-number="20">}</a></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1">get_S0 &lt;-<span class="st"> </span><span class="cf">function</span>(tensors) {</a>
<a class="sourceLine" id="cb28-2" data-line-number="2"></a>
<a class="sourceLine" id="cb28-3" data-line-number="3">  <span class="kw">return</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/oro.nifti/topics/as.nifti">as.nifti</a></span>(tensors<span class="op">@</span>th0))</a>
<a class="sourceLine" id="cb28-4" data-line-number="4"></a>
<a class="sourceLine" id="cb28-5" data-line-number="5">}</a>
<a class="sourceLine" id="cb28-6" data-line-number="6"></a>
<a class="sourceLine" id="cb28-7" data-line-number="7">compute_mask &lt;-<span class="st"> </span><span class="cf">function</span>(S0) {</a>
<a class="sourceLine" id="cb28-8" data-line-number="8"></a>
<a class="sourceLine" id="cb28-9" data-line-number="9">  S0_file &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/neurobase/topics/tempimg">tempimg</a></span>(S0)</a>
<a class="sourceLine" id="cb28-10" data-line-number="10"></a>
<a class="sourceLine" id="cb28-11" data-line-number="11">  brain_mask &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/fslr/topics/fslbet">fslbet</a></span>(<span class="dt">infile =</span> S0_file)</a>
<a class="sourceLine" id="cb28-12" data-line-number="12"></a>
<a class="sourceLine" id="cb28-13" data-line-number="13">  <span class="kw">return</span>(brain_mask <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb28-14" data-line-number="14"></a>
<a class="sourceLine" id="cb28-15" data-line-number="15">}</a></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1">fibertracking &lt;-<span class="st"> </span><span class="cf">function</span>(tensors, mask) {</a>
<a class="sourceLine" id="cb29-2" data-line-number="2"></a>
<a class="sourceLine" id="cb29-3" data-line-number="3">  fibers &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/dti/topics/tracking-methods">tracking</a></span>(tensors,</a>
<a class="sourceLine" id="cb29-4" data-line-number="4">                     <span class="dt">mask =</span> mask)</a>
<a class="sourceLine" id="cb29-5" data-line-number="5"></a>
<a class="sourceLine" id="cb29-6" data-line-number="6">  <span class="kw">return</span>(fibers)</a>
<a class="sourceLine" id="cb29-7" data-line-number="7"></a>
<a class="sourceLine" id="cb29-8" data-line-number="8">}</a></code></pre></div>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1">compute_FA &lt;-<span class="st"> </span><span class="cf">function</span>(tensors, mask) {</a>
<a class="sourceLine" id="cb30-2" data-line-number="2"></a>
<a class="sourceLine" id="cb30-3" data-line-number="3">  indices &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/dti/topics/dtiIndices-methods">dtiIndices</a></span>(tensors)</a>
<a class="sourceLine" id="cb30-4" data-line-number="4"></a>
<a class="sourceLine" id="cb30-5" data-line-number="5">  FA_map &lt;-<span class="st"> </span>indices<span class="op">@</span>fa <span class="op">*</span><span class="st"> </span>mask</a>
<a class="sourceLine" id="cb30-6" data-line-number="6"></a>
<a class="sourceLine" id="cb30-7" data-line-number="7">  <span class="kw">return</span>(FA_map)</a>
<a class="sourceLine" id="cb30-8" data-line-number="8"></a>
<a class="sourceLine" id="cb30-9" data-line-number="9">}</a></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#objective">Objective</a></li>
      <li>
<a href="#requirements">Requirements</a><ul class="nav nav-pills nav-stacked">
<li><a href="#packages">Packages</a></li>
      <li><a href="#other-resources">Other Resources</a></li>
      </ul>
</li>
      <li>
<a href="#dti-processing">DTI Processing</a><ul class="nav nav-pills nav-stacked">
<li><a href="#eddy-current-correction">Eddy Current Correction</a></li>
      <li><a href="#tensor-computation">Tensor Computation</a></li>
      <li><a href="#mask-computation">Mask Computation</a></li>
      <li><a href="#fiber-tracking">Fiber Tracking</a></li>
      <li><a href="#fa-map">FA Map</a></li>
      </ul>
</li>
      <li><a href="#final-flow">Final Flow</a></li>
      <li>
<a href="#example">Example</a><ul class="nav nav-pills nav-stacked">
<li><a href="#code">Code</a></li>
      <li><a href="#images">Images</a></li>
      <li><a href="#full-flow-log">Full Flow Log</a></li>
      </ul>
</li>
      <li><a href="#annex-full-code">Annex: Full Code</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Domingo Lopez-Rodriguez.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
